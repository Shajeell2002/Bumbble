<h2>Friend Requests</h2>
<div id="notificationList"></div>

<script>
  // Initialize Firebase references
  const auth = firebase.auth();
  const db = firebase.database();

  auth.onAuthStateChanged(user => {
    if (!user) {
      document.getElementById("notificationList").innerHTML = "<p>Please login</p>";
      return;
    }

    const uid = user.uid;
    const container = document.getElementById("notificationList");

    db.ref("friendRequests/" + uid).on("value", async (snap) => {
      container.innerHTML = "";

      if (!snap.exists()) {
        container.innerHTML = "<p>No new notifications</p>";
        return;
      }

      const requests = snap.val();

      for (const senderUid in requests) {
        try {
          const userSnap = await db.ref("users/" + senderUid + "/public").once("value");
          const userData = userSnap.val();
          const name = userData && userData.name ? userData.name : "Unknown User";

          const div = document.createElement("div");
          div.style.border = "1px solid #ccc";
          div.style.padding = "10px";
          div.style.marginBottom = "10px";

          const text = document.createElement("p");
          text.textContent = `${name} sent you a friend request`;

          const acceptBtn = document.createElement("button");
          acceptBtn.textContent = "Accept";
          acceptBtn.onclick = () => acceptRequest(senderUid);

          const rejectBtn = document.createElement("button");
          rejectBtn.textContent = "Reject";
          rejectBtn.style.marginLeft = "10px";
          rejectBtn.onclick = () => rejectRequest(senderUid);

          div.appendChild(text);
          div.appendChild(acceptBtn);
          div.appendChild(rejectBtn);

          container.appendChild(div);

        } catch (error) {
          console.error("Error loading user data:", error);
        }
      }
    });
  });

  async function acceptRequest(senderUid) {
    try {
      const currentUser = firebase.auth().currentUser;
      if (!currentUser) return;

      const currentUid = currentUser.uid;
      const updates = {};

      updates["friends/" + currentUid + "/" + senderUid] = true;
      updates["friends/" + senderUid + "/" + currentUid] = true;
      updates["friendRequests/" + currentUid + "/" + senderUid] = null;

      await db.ref().update(updates);

      alert("Friend request accepted ✅");

    } catch (error) {
      console.error("Error accepting request:", error);
    }
  }

  async function rejectRequest(senderUid) {
    try {
      const currentUser = firebase.auth().currentUser;
      if (!currentUser) return;

      const currentUid = currentUser.uid;

      await db.ref("friendRequests/" + currentUid + "/" + senderUid).remove();

      alert("Friend request rejected ❌");

    } catch (error) {
      console.error("Error rejecting request:", error);
    }
  }
</script>
