<script>
const nav = document.getElementById("navLinks");

auth.onAuthStateChanged(user => {
  if(user && user.emailVerified){
    localStorage.setItem("current_user", user.uid);

    nav.innerHTML = `
      <a href="index.html">Home</a>
      <a href="friends.html">Friends</a>
      <a href="stories.html">Stories</a>
      <a href="events.html">Events</a>
      <a href="safety.html">Safety</a>
      <a href="profile.html">Profile</a>
      <a href="#" id="logoutBtn">Logout</a>
    `;
    document.getElementById("logoutBtn").addEventListener("click", () => {
      auth.signOut().then(() => {
        localStorage.removeItem("current_user");
        window.location.href="login.html";
      });
    });

    const profileContainer = document.getElementById("profileContainer");
    const userRef = db.ref("users/" + user.uid);

    // Set online status
    const onlineRef = userRef.child("online");
    onlineRef.set(true);
    onlineRef.onDisconnect().set(false);

    // Load profile
    userRef.on("value", snapshot => {
      const u = snapshot.val() || {};
      const online = u.online ? true : false;

      profileContainer.innerHTML = `
        <img id="profilePic" src="${u.pic || 'images/profile1.png'}" alt="Profile">
        <input type="file" id="picUpload" accept="image/*">

        <label>Name</label>
        <input type="text" id="name" value="${u.name || ''}">

        <label>Email (readonly)</label>
        <input type="email" id="email" value="${u.email || user.email}" readonly>

        <label>Gender</label>
        <select id="gender">
          <option value="">Select Gender</option>
          <option value="Male" ${u.gender==='Male'?'selected':''}>Male</option>
          <option value="Female" ${u.gender==='Female'?'selected':''}>Female</option>
          <option value="Other" ${u.gender==='Other'?'selected':''}>Other</option>
        </select>

        <label>Location</label>
        <input type="text" id="location" value="${u.location || ''}">

        <label>Age</label>
        <input type="number" id="age" value="${u.age || ''}">

        <p>Status: <span class="status-dot" style="background-color:${online?'green':'red'}"></span></p>

        <button id="saveBtn">Save Profile</button>
      `;

      const profileImg = document.getElementById("profilePic");
      const picInput = document.getElementById("picUpload");

      let selectedFile = null; // Store selected file before saving

      // Show preview immediately
      picInput.addEventListener("change", e => {
        const file = e.target.files[0];
        if(file){
          selectedFile = file;

          const reader = new FileReader();
          reader.onload = function(event){
            profileImg.src = event.target.result;
          };
          reader.readAsDataURL(file);

          const MAX_SIZE = 2*1024*1024; // 2 MB
          if(file.size > MAX_SIZE){
            alert("⚠️ File exceeds 2MB.");
            selectedFile = null;
            e.target.value = "";
            profileImg.src = u.pic || 'images/profile1.png';
            return;
          }
        }
      });

      // Save profile updates
      document.getElementById("saveBtn").addEventListener("click", async () => {
        const updatedName = document.getElementById("name").value.trim();
        const updatedGender = document.getElementById("gender").value;
        const updatedLocation = document.getElementById("location").value.trim();
        const updatedAge = parseInt(document.getElementById("age").value);

        if(!updatedName || !updatedGender || !updatedLocation || !updatedAge){
          alert("⚠️ Please fill all fields");
          return;
        }

        try {
          // Upload profile pic first if selected
          let picURL = u.pic || null;
          if(selectedFile){
            const storageRef = storage.ref("profile_pics/" + user.uid + ".jpg");
            const snapshot = await storageRef.put(selectedFile);
            picURL = await snapshot.ref.getDownloadURL();
          }

          // Update profile data
          await userRef.update({
            name: updatedName,
            gender: updatedGender,
            location: updatedLocation,
            age: updatedAge,
            pic: picURL
          });

          alert("✅ Profile updated successfully!");
          selectedFile = null; // reset selected file

        } catch(err) {
          alert("❌ Error updating profile: " + err.message);
        }
      });

    });

  } else {
    nav.innerHTML = `
      <a href="index.html">Home</a>
      <a href="login.html">Login</a>
      <a href="signup.html">Sign Up</a>
    `;
    profileContainer.innerHTML = "<p>Please login to view profile.</p>";
  }
});
</script>
