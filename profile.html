<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>User Profile</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f3ff;
      margin: 0;
      padding: 20px;
    }
    .container {
      max-width: 500px;
      margin: auto;
      background: #fff;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 0 12px rgba(0,0,0,0.1);
    }
    h2 {
      text-align: center;
      margin-bottom: 20px;
      color: #5b4b8a;
    }
    .profile-pic {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      object-fit: cover;
      display: block;
      margin: 0 auto 10px;
    }
    label { font-weight: bold; color:#444; margin-top: 10px; display: block; }
    input, select, textarea {
      width: 100%;
      padding: 10px;
      margin-top: 5px;
      border: 1px solid #ccc;
      border-radius: 8px;
    }
    button {
      width: 100%;
      padding: 12px;
      border: none;
      background: #6c5ce7;
      color: #fff;
      margin-top: 20px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
    }
  </style>
</head>
<body>

<div class="container">
  <h2>Your Profile</h2>

  <img id="profilePreview" class="profile-pic" src="images/profile1.png" />
  <input type="file" id="profilePic" accept="image/*" />

  <label>Full Name</label>
  <input type="text" id="fullName" />

  <label>Gender</label>
  <select id="gender">
    <option value="Male">Male</option>
    <option value="Female">Female</option>
    <option value="Other">Other</option>
  </select>

  <label>Date of Birth</label>
  <input type="date" id="dob" />

  <label>Age</label>
  <input type="number" id="age" />

  <label>Location</label>
  <input type="text" id="location" />

  <label>Looking For</label>
  <select id="lookingFor">
    <option value="Friendship">Friendship</option>
    <option value="Relationship">Relationship</option>
    <option value="Marriage">Marriage</option>
  </select>

  <label>Purpose</label>
  <input type="text" id="purpose" />

  <label>Username</label>
  <input type="text" id="username" />

  <label>Email (read-only)</label>
  <input type="email" id="email" readonly />

  <label>Bio</label>
  <textarea id="bio" rows="4"></textarea>

  <button onclick="saveProfile()">Save Profile</button>
</div>

<script type="module">
  // --- Firebase Config (Your Real Project) ---
  const firebaseConfig = {
    apiKey: "AIzaSyBkDyP8KPuQc_knXLH9lhtQWDLb59xRJWs",
    authDomain: "bumbble-d3588.firebaseapp.com",
    projectId: "bumbble-d3588",
    storageBucket: "bumbble-d3588.appspot.com",
    messagingSenderId: "555784264359",
    appId: "1:555784264359:web:67840fe75aca253e7188b7",
    measurementId: "G-M781XJ26GN"
  };

  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getDatabase, ref, set, get, onValue, update, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const auth = getAuth(app);

  let currentUsername = "";
  let profileBase64 = "";

  // --- Image Preview + Base64 ---
  document.getElementById("profilePic").addEventListener("change", function (event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function (e) {
      profileBase64 = e.target.result;
      document.getElementById("profilePreview").src = profileBase64;
    };
    reader.readAsDataURL(file);
  });

  // --- Load User Data in Real Time ---
  onAuthStateChanged(auth, (user) => {
    if (!user) return;

    const userRef = ref(db, `users/${user.uid}`);
    onValue(userRef, (snapshot) => {
      if (!snapshot.exists()) return;
      const data = snapshot.val();

      document.getElementById("fullName").value = data.fullName || "";
      document.getElementById("gender").value = data.gender || "";
      document.getElementById("dob").value = data.dob || "";
      document.getElementById("age").value = data.age || "";
      document.getElementById("location").value = data.location || "";
      document.getElementById("lookingFor").value = data.lookingFor || "";
      document.getElementById("purpose").value = data.purpose || "";
      document.getElementById("username").value = data.username || "";
      document.getElementById("email").value = user.email;
      document.getElementById("bio").value = data.bio || "";

      currentUsername = data.username || "";

      if (!document.getElementById("profilePic").files.length) {
        profileBase64 = data.pic || "";
        document.getElementById("profilePreview").src = data.pic || "images/profile1.png";
      }
    });
  });

  // --- Save Profile ---
  async function saveProfile() {
    const user = auth.currentUser;
    if (!user) return alert("Not logged in.");

    const newUsername = document.getElementById("username").value.trim();
    if (!newUsername) return alert("Username cannot be empty.");

    // Check if username is already taken (except old one)
    if (newUsername !== currentUsername) {
      const usernameRef = ref(db, `usernames/${newUsername}`);
      const usernameSnap = await get(usernameRef);
      if (usernameSnap.exists()) return alert("Username already taken.");
    }

    // Update user data
    const userRef = ref(db, `users/${user.uid}`);
    await update(userRef, {
      fullName: document.getElementById("fullName").value,
      gender: document.getElementById("gender").value,
      dob: document.getElementById("dob").value,
      age: document.getElementById("age").value,
      location: document.getElementById("location").value,
      lookingFor: document.getElementById("lookingFor").value,
      purpose: document.getElementById("purpose").value,
      username: newUsername,
      bio: document.getElementById("bio").value,
      pic: profileBase64 || "images/profile1.png"
    });

    // Handle username table
    if (currentUsername && currentUsername !== newUsername) {
      await remove(ref(db, `usernames/${currentUsername}`));
    }
    await set(ref(db, `usernames/${newUsername}`), user.uid);

    currentUsername = newUsername;
    alert("Profile Updated Successfully!");
  }
</script>

</body>
</html>
