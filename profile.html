<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Bumbble - Profile</title>
<style>
body { font-family: Arial,sans-serif; background:#fff; color:#333; margin:0; display:flex; flex-direction:column; min-height:100vh; }
header { display:flex; justify-content:space-between; align-items:center; padding:20px; background:#ffcb2b; }
header h1 { font-size:24px; }
nav a { margin:0 10px; text-decoration:none; color:#333; font-weight:bold; }
.profile-container { flex:1; max-width:400px; margin:30px auto; padding:20px; border-radius:10px; border:1px solid #ddd; box-shadow:0 2px 8px rgba(0,0,0,0.1); }
.profile-container h2 { text-align:center; margin-bottom:20px; }
.profile-container input[type=text], .profile-container input[type=number], .profile-container input[type=email] { width:100%; padding:8px; margin:8px 0; border:1px solid #ccc; border-radius:5px; }
.profile-container input[type=file] { margin:8px 0; }
.profile-container button { width:100%; padding:10px; margin-top:10px; background:#ffcb2b; border:none; border-radius:5px; font-weight:bold; cursor:pointer; }
.profile-container button:hover { background:#f1b800; }
.error-msg { color:red; font-size:14px; margin-top:5px; }
#profilePreview { width:100px; height:100px; border-radius:50%; object-fit:cover; margin:10px 0; }
</style>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
</head>
<body>

<header>
  <h1>Bumbble</h1>
  <nav id="navLinks"></nav>
</header>

<div class="profile-container">
  <h2>Your Profile</h2>
  <img id="profilePreview" src="images/profile1.png" alt="Profile Picture">
  <input type="file" id="profilePic" accept="image/*">
  <input type="text" id="name" placeholder="Full Name">
  <input type="number" id="age" placeholder="Age">
  <input type="text" id="location" placeholder="Location">
  <input type="email" id="email" placeholder="Email" disabled>
  <button onclick="updateProfile()">Update Profile</button>
  <p class="error-msg" id="errorMsg"></p>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyBkDyP8KPuQc_knXLH9lhtQWDLb59xRJWs",
  authDomain: "bumbble-c061f.firebaseapp.com",
  databaseURL: "https://bumbble-c061f-default-rtdb.firebaseio.com",
  projectId: "bumbble-c061f",
  storageBucket: "bumbble-c061f.appspot.com",
  messagingSenderId: "213165886981",
  appId: "1:213165886981:web:c18652003444869b1bd66c"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();
const storage = firebase.storage();

const nav = document.getElementById("navLinks");
const errorMsg = document.getElementById("errorMsg");
const profilePreview = document.getElementById("profilePreview");
let profileThumbnailBase64 = "";
let originalFile = null;

// Auth & navigation
auth.onAuthStateChanged(user => {
  if (user && user.emailVerified) {
    nav.innerHTML = `
      <a href="index.html">Home</a>
      <a href="friends.html">Friends</a>
      <a href="stories.html">Stories</a>
      <a href="events.html">Events</a>
      <a href="safety.html">Safety</a>
      <a href="profile.html">Profile</a>
      <a href="#" id="logoutBtn">Logout</a>
    `;
    document.getElementById("logoutBtn").addEventListener("click", ()=> auth.signOut().then(()=>window.location.href="login.html"));
    loadProfile(user.uid);
    listenRealtime(user.uid);
  } else {
    nav.innerHTML = `<a href="index.html">Home</a><a href="login.html">Login</a><a href="signup.html">Sign Up</a>`;
    document.querySelector(".profile-container").innerHTML = "<p>Please login to view your profile.</p>";
  }
});

// Compress image to <=64KB
function compressImage(file, maxSizeKB = 64, callback) {
  const reader = new FileReader();
  reader.onload = function(evt) {
    const img = new Image();
    img.onload = function() {
      const canvas = document.createElement('canvas');
      let width = img.width, height = img.height;
      const maxDim = 200;
      if(width > height && width > maxDim){ height = Math.round(height*maxDim/width); width = maxDim; }
      else if(height > width && height > maxDim){ width = Math.round(width*maxDim/height); height = maxDim; }
      else if(width > maxDim){ width = height = maxDim; }
      canvas.width = width; canvas.height = height;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img,0,0,width,height);

      let quality = 0.9;
      let dataUrl = canvas.toDataURL('image/jpeg', quality);
      while((dataUrl.length/1024) > maxSizeKB && quality > 0.05){
        quality -= 0.05;
        dataUrl = canvas.toDataURL('image/jpeg', quality);
      }
      callback(dataUrl);
    }
    img.src = evt.target.result;
  }
  reader.readAsDataURL(file);
}

// Handle file upload & preview
document.getElementById("profilePic").addEventListener("change", e => {
  const file = e.target.files[0];
  if(!file) return;

  if(file.size > 2*1024*1024){ // 2MB limit
    errorMsg.textContent = "File too large! Max 2MB.";
    return;
  }

  originalFile = file;
  compressImage(file, 64, (compressedDataUrl) => {
    profileThumbnailBase64 = compressedDataUrl;
    profilePreview.src = profileThumbnailBase64;
    errorMsg.textContent = "";
  });
});

// Load profile data once
async function loadProfile(uid){
  try {
    const publicSnap = await db.ref(`users/${uid}/public`).once('value');
    const privateSnap = await db.ref(`users/${uid}/private`).once('value');
    const publicData = publicSnap.val() || {};
    const privateData = privateSnap.val() || {};
    document.getElementById("name").value = publicData.name || "";
    document.getElementById("age").value = publicData.age || "";
    document.getElementById("location").value = publicData.location || "";
    document.getElementById("email").value = privateData.email || "";
    profilePreview.src = publicData.pic || "images/profile1.png";
    profileThumbnailBase64 = publicData.pic || "";
  } catch(err){ console.error(err); errorMsg.textContent="Failed to load profile."; }
}

// Realtime updates from Firebase
function listenRealtime(uid){
  db.ref(`users/${uid}/public`).on('value', snap => {
    const data = snap.val() || {};
    document.getElementById("name").value = data.name || "";
    document.getElementById("age").value = data.age || "";
    document.getElementById("location").value = data.location || "";
    profilePreview.src = data.pic || "images/profile1.png";
    profileThumbnailBase64 = data.pic || "";
  });
}

// Update profile
async function updateProfile(){
  const user = auth.currentUser;
  if(!user) return;

  const uid = user.uid;
  const name = document.getElementById("name").value.trim();
  const age = document.getElementById("age").value.trim();
  const location = document.getElementById("location").value.trim();
  errorMsg.textContent = "";
  if(!name) return errorMsg.textContent = "Name cannot be empty!";

  try{
    let picToSave = profileThumbnailBase64;

    // Upload original full-size image to Firebase Storage if user selected a new file
    if(originalFile){
      const storageRef = storage.ref(`users/${uid}/profile_original.jpg`);
      await storageRef.put(originalFile);
      const downloadURL = await storageRef.getDownloadURL();
      console.log("Original image stored at:", downloadURL);
    }

    // Update public node in Realtime DB with thumbnail
    await db.ref(`users/${uid}/public`).update({
      name,
      age: age || "N/A",
      location: location || "",
      pic: picToSave || "images/profile1.png"
    });
    alert("Profile updated successfully!");
  } catch(err){
    console.error("Profile update error:", err);
    errorMsg.textContent="Failed to update profile.";
  }
}
</script>
</body>
</html>
