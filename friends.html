<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Bumbble - Friends & Chat</title>
<style>
body {
  font-family: Arial, sans-serif;
  margin: 0;
  background: #fefefe;
  color: #333;
  display: flex;
  flex-direction: column;
  min-height: 100vh;
}
header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px 15px;
  background: #f7c948;
  font-weight: bold;
}
.container {
  display: flex;
  flex: 1;
  overflow: hidden;
}
#friendsList {
  width: 30%;
  background: #fff8e1;
  border-right: 1px solid #ddd;
  overflow-y: auto;
}
#chatContainer {
  flex: 1;
  display: flex;
  flex-direction: column;
}
.user-row {
  padding: 10px;
  border-bottom: 1px solid #eee;
  display: flex;
  justify-content: space-between;
  align-items: center;
  cursor: pointer;
  transition: background 0.3s;
}
.user-row:hover { background: #ffecb3; }
.user-row.flash {
  background: #ffe082 !important;
  transition: background 0.5s;
}
.badge {
  background: red;
  color: white;
  border-radius: 10px;
  padding: 2px 7px;
  font-size: 12px;
  margin-left: 8px;
}
#messages {
  flex: 1;
  padding: 10px;
  overflow-y: auto;
  background: #fff;
  display: flex;
  flex-direction: column;
}
.message {
  margin: 5px 0;
  padding: 8px 12px;
  border-radius: 10px;
  max-width: 70%;
}
.sent { background: #e0f7fa; align-self: flex-end; }
.received { background: #f1f8e9; align-self: flex-start; }
#inputArea {
  display: flex;
  padding: 10px;
  background: #fafafa;
  border-top: 1px solid #ddd;
}
#inputArea input[type="text"] {
  flex: 1;
  padding: 8px;
  border: 1px solid #ccc;
  border-radius: 4px;
}
#inputArea button {
  margin-left: 8px;
  padding: 8px 15px;
  border: none;
  background: #f7c948;
  border-radius: 4px;
  cursor: pointer;
  font-weight: bold;
}
</style>
</head>
<body>

<header>
  <span>Bumbble Friends</span>
  <button id="logoutBtn">Logout</button>
</header>

<div class="container">
  <div id="friendsList">Loading friends...</div>

  <div id="chatContainer">
    <div id="messages"></div>
    <div id="inputArea">
      <input id="messageInput" type="text" placeholder="Type a message..." />
      <input type="file" id="fileInput" style="display:none;" />
      <button id="uploadBtn">ðŸ“Ž</button>
      <button id="sendBtn">Send</button>
    </div>
  </div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>

<script>
// ====== Firebase Config ======
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_AUTH_DOMAIN",
  databaseURL: "YOUR_DB_URL",
  projectId: "YOUR_PROJECT_ID",
  storageBucket: "YOUR_STORAGE_BUCKET",
  messagingSenderId: "YOUR_SENDER_ID",
  appId: "YOUR_APP_ID"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const storage = firebase.storage();

let currentUserUid = null;
let currentChatFriendUid = null;
let unreadCounters = {};
let lastChatTimestamps = {};
let friends = [];

// ====== Auth Check ======
firebase.auth().onAuthStateChanged(user => {
  if (user) {
    currentUserUid = user.uid;
    loadFriends();
    listenUnreadMessages();
  } else {
    window.location.href = "login.html";
  }
});
document.getElementById("logoutBtn").onclick = () => firebase.auth().signOut();

// ====== Load Friends ======
function loadFriends() {
  db.ref("users").on("value", snapshot => {
    const data = snapshot.val() || {};
    friends = [];

    Object.keys(data).forEach(uid => {
      if (uid === currentUserUid) return;
      const u = data[uid].public || data[uid];
      friends.push({
        uid,
        name: u.name || "Unknown",
        gender: u.gender || "N/A"
      });
    });

    renderFriends();
  });
}

function renderFriends() {
  const list = document.getElementById("friendsList");
  if (friends.length === 0) {
    list.innerHTML = "<p>No users found.</p>";
    return;
  }
  list.innerHTML = "";

  const sorted = friends.sort((a, b) => (lastChatTimestamps[b.uid] || 0) - (lastChatTimestamps[a.uid] || 0));
  sorted.forEach(u => {
    const div = document.createElement("div");
    div.className = "user-row";
    div.dataset.uid = u.uid;
    div.innerHTML = `
      <div>${u.name}</div>
      ${unreadCounters[u.uid] ? `<span class="badge">${unreadCounters[u.uid]}</span>` : ""}
    `;
    div.onclick = () => openChat(u.uid, u.name);
    list.appendChild(div);
  });
}

// ====== Open Chat ======
function openChat(uid, name) {
  currentChatFriendUid = uid;
  unreadCounters[uid] = 0;
  renderFriends();

  const messagesDiv = document.getElementById("messages");
  messagesDiv.innerHTML = `<h4>Chat with ${name}</h4>`;

  const chatId = getChatId(currentUserUid, uid);
  db.ref(`chats/${chatId}/messages`).off();
  db.ref(`chats/${chatId}/messages`).on("child_added", snap => {
    const msg = snap.val();
    displayMessage(msg);
  });
}

// ====== Display Message ======
function displayMessage(msg) {
  const div = document.createElement("div");
  div.className = "message " + (msg.sender === currentUserUid ? "sent" : "received");

  if (msg.text) div.textContent = msg.text;
  if (msg.fileUrl) {
    const a = document.createElement("a");
    a.href = msg.fileUrl;
    a.target = "_blank";
    a.textContent = "ðŸ“Ž File";
    div.appendChild(a);
  }

  document.getElementById("messages").appendChild(div);
  const container = document.getElementById("messages");
  container.scrollTop = container.scrollHeight;
}

// ====== Send Message ======
document.getElementById("sendBtn").onclick = () => {
  const input = document.getElementById("messageInput");
  const text = input.value.trim();
  if (!text || !currentChatFriendUid) return;

  const chatId = getChatId(currentUserUid, currentChatFriendUid);
  const msg = {
    sender: currentUserUid,
    receiver: currentChatFriendUid,
    text,
    timestamp: Date.now()
  };
  db.ref(`chats/${chatId}/messages`).push(msg);
  lastChatTimestamps[currentChatFriendUid] = msg.timestamp;
  input.value = "";
  renderFriends();
};

// ====== File Upload ======
document.getElementById("uploadBtn").onclick = () => document.getElementById("fileInput").click();

document.getElementById("fileInput").onchange = e => {
  const file = e.target.files[0];
  if (!file || !currentChatFriendUid) return;
  const chatId = getChatId(currentUserUid, currentChatFriendUid);
  const ref = storage.ref(`chat_files/${chatId}/${Date.now()}_${file.name}`);

  ref.put(file).then(() =>
    ref.getDownloadURL().then(url => {
      const msg = {
        sender: currentUserUid,
        receiver: currentChatFriendUid,
        fileUrl: url,
        timestamp: Date.now()
      };
      db.ref(`chats/${chatId}/messages`).push(msg);
      lastChatTimestamps[currentChatFriendUid] = msg.timestamp;
      renderFriends();
    })
  );
};

// ====== Listen for Unread Messages ======
function listenUnreadMessages() {
  db.ref("chats").on("child_added", snap => {
    const chatRef = snap.ref.child("messages");
    chatRef.on("child_added", msgSnap => {
      const msg = msgSnap.val();
      if (!msg) return;

      if (msg.receiver === currentUserUid) {
        if (msg.sender !== currentChatFriendUid) {
          unreadCounters[msg.sender] = (unreadCounters[msg.sender] || 0) + 1;
        }
        lastChatTimestamps[msg.sender] = msg.timestamp;
        renderFriends();
        flashUserRow(msg.sender);
      }
    });
  });
}

// ====== Helpers ======
function flashUserRow(uid) {
  const row = document.querySelector(`.user-row[data-uid="${uid}"]`);
  if (row) {
    row.classList.add("flash");
    setTimeout(() => row.classList.remove("flash"), 1000);
  }
}

function getChatId(a, b) {
  return a < b ? `${a}_${b}` : `${b}_${a}`;
}
</script>
</body>
</html>
