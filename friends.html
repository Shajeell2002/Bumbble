<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Bumbble - Friends & Chat</title>
<style>
body { 
  font-family: Arial, sans-serif; 
  margin:0; 
  background:#fefefe; 
  color:#333; 
  display:flex; 
  min-height:100vh; 
  flex-direction: column;
}

/* Header */
header { 
  display:flex; 
  justify-content:space-between; 
  align-items:center; 
  padding:15px 20px; 
  background:#ffcb2b; 
  box-shadow:0 3px 6px rgba(0,0,0,0.1);
  position:fixed;
  top:0; left:0; right:0;
  z-index:500;
}
header h1{ font-size:24px; margin:0; display:flex; align-items:center; gap:10px; }
nav a{ margin-left:10px; font-weight:bold; color:#333; text-decoration:none; }
nav a:hover{ text-decoration:underline; }
#sidebarToggle { display:none; font-size:20px; cursor:pointer; }

/* Sidebar */
.friends-container {
  width:250px; 
  background:#fffbe6;
  border-right:1px solid #eee;
  padding:10px;
  overflow-y:auto;
  position:fixed;
  top:60px;
  bottom:0;
  left:0;
  transition: transform 0.3s ease;
  z-index:400;
}
.friends-container.hide {
  transform: translateX(-100%);
}

/* Main content */
.main-content {
  flex:1;
  margin-left:250px;
  padding:80px 20px 20px 20px;
  transition: margin-left 0.3s ease;
}
.main-content.full { margin-left:0; }

/* User list */
.user-list {
  display:flex;
  flex-direction:column;
  gap:2px;
  font-size:14px;
}
.user-row { 
  display:flex; 
  justify-content:space-between; 
  align-items:center; 
  padding:6px 8px; 
  border-bottom:1px solid #eee; 
  cursor:pointer; 
  transition:background 0.2s; 
}
.user-row:hover { background:#fffbcc; }

.status-dot {
  width:10px; height:10px; border-radius:50%; display:inline-block; margin-right:6px;
}
.online { background:green; }
.offline { background:red; }

.badge {
  background:red; color:white; font-size:10px; font-weight:bold;
  padding:1px 5px; border-radius:10px; margin-left:6px;
}

/* Chat modal */
#chatModal {
  position:fixed;
  bottom:0; right:20px;
  width:300px; max-height:400px;
  border:1px solid #ccc; background:#fff;
  border-radius:10px 10px 0 0;
  display:none;
  flex-direction:column;
  box-shadow:0 4px 12px rgba(0,0,0,0.2);
  resize:both;
  overflow:hidden;
  z-index:1000;
}
#chatHeader {
  background:#ffcb2b;
  padding:10px; font-weight:bold;
  display:flex; justify-content:space-between; align-items:center;
  border-radius:10px 10px 0 0;
  cursor:move;
}
#chatMessages { flex:1; padding:10px; overflow-y:auto; display:flex; flex-direction:column; gap:6px; background:#fefefe; }
#typingIndicator { font-size:12px; color:#555; padding-left:10px; height:18px; }
.message { max-width:80%; padding:6px 10px; border-radius:10px; position:relative; word-wrap:break-word; }
.message.self { background:green; color:white; align-self:flex-end; }
.message.friend { background:#e0e0e0; align-self:flex-start; }
.timestamp { font-size:10px; color:#555; margin-top:2px; text-align:right; }
#chatInputContainer { display:flex; border-top:1px solid #ddd; }
#chatInput { flex:1; padding:8px; border:none; outline:none; border-radius:0 0 0 10px; }
#sendBtn { padding:8px 12px; border:none; background:#ffcb2b; border-radius:0 0 10px 0; cursor:pointer; }
#sendBtn:hover { background:#f1b800; }

/* Scrollbar */
.friends-container::-webkit-scrollbar { width:6px; }
.friends-container::-webkit-scrollbar-thumb { background:#ffcb2b; border-radius:3px; }
.friends-container::-webkit-scrollbar-track { background:#f1f1f1; }

@media screen and (max-width:768px){
  #sidebarToggle { display:block; }
  .friends-container { transform: translateX(-100%); }
  .main-content { margin-left:0; }
}
</style>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>
<body>

<header>
  <h1><span id="sidebarToggle">&#9776;</span> Bumbble</h1>
  <nav id="navLinks"></nav>
</header>

<div class="friends-container" id="sidebar">
  <div class="user-list" id="userList"></div>
</div>

<div class="main-content" id="mainContent">
  <div id="chatModal">
    <div id="chatHeader">
      <span id="chatWith">Friend</span>
      <button onclick="closeChat()">X</button>
    </div>
    <div id="chatMessages"></div>
    <div id="typingIndicator"></div>
    <div id="chatInputContainer">
      <input type="text" id="chatInput" placeholder="Type a message">
      <button id="sendBtn">Send</button>
    </div>
  </div>
</div>

<script>
// Sidebar toggle + swipe
const sidebar = document.getElementById('sidebar');
const mainContent = document.getElementById('mainContent');
const sidebarToggle = document.getElementById('sidebarToggle');
sidebarToggle.addEventListener('click', () => {
  sidebar.classList.toggle('hide');
  mainContent.classList.toggle('full');
});
let startX=0,endX=0;
document.addEventListener('touchstart',e=>startX=e.changedTouches[0].screenX,{passive:true});
document.addEventListener('touchend',e=>{endX=e.changedTouches[0].screenX;if(endX-startX>50){sidebar.classList.remove('hide');mainContent.classList.remove('full');}else if(startX-endX>50){sidebar.classList.add('hide');mainContent.classList.add('full');}}, {passive:true});

// Firebase setup
const firebaseConfig = { 
  apiKey:"AIzaSyBkDyP8KPuQc_knXLH9lhtQWDLb59xRJWs", 
  authDomain:"bumbble-c061f.firebaseapp.com", 
  databaseURL:"https://bumbble-c061f-default-rtdb.firebaseio.com", 
  projectId:"bumbble-c061f", 
  storageBucket:"bumbble-c061f.appspot.com", 
  messagingSenderId:"213165886981", 
  appId:"1:213165886981:web:c18652003444869b1bd66c" 
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();

const nav=document.getElementById("navLinks"),userList=document.getElementById("userList");
let currentUserUid="",currentChatFriendUid="",currentChatListener=null;
const chatModal=document.getElementById("chatModal"),chatMessages=document.getElementById("chatMessages"),
chatWith=document.getElementById("chatWith"),chatInput=document.getElementById("chatInput"),
sendBtn=document.getElementById("sendBtn"),typingIndicator=document.getElementById("typingIndicator");
let typingTimeout; const unreadCounters={};

// Auth state
auth.onAuthStateChanged(user=>{
  if(user&&user.emailVerified){
    currentUserUid=user.uid;
    nav.innerHTML=`<a href="index.html">Home</a>
    <a href="friends.html">Friends</a>
    <a href="stories.html">Stories</a>
    <a href="events.html">Events</a>
    <a href="safety.html">Safety</a>
    <a href="profile.html">Profile</a>
    <a href="#" id="logoutBtn">Logout</a>`;
    document.getElementById("logoutBtn").onclick=()=>{db.ref('users/'+currentUserUid+'/public/online').set(false);auth.signOut().then(()=>location.href="login.html");};
    setupOnlineStatus(); loadUsersRealtime();
  } else {
    nav.innerHTML=`<a href="index.html">Home</a><a href="login.html">Login</a><a href="signup.html">Sign Up</a>`;
    userList.innerHTML="<p>Please login to view users.</p>";
  }
});

function setupOnlineStatus(){
  const refUser=db.ref('users/'+currentUserUid+'/public/online');
  db.ref('.info/connected').on('value',snap=>{
    if(snap.val()===true){refUser.set(true);refUser.onDisconnect().set(false);}
  });
}

// Load users
function loadUsersRealtime(){
  db.ref('users').on('value',snap=>{
    const users=snap.val()||{}; userList.innerHTML='';
    let lastFriendUid=null,lastFriendName="";
    Object.keys(users).forEach(uid=>{
      if(uid===currentUserUid)return;
      const u=users[uid].public||{}; const name=u.name||"Unknown",gender=u.gender||"N/A";
      lastFriendUid=uid; lastFriendName=name; // keep track of last friend
      const row=document.createElement('div'); row.className="user-row"; row.dataset.uid=uid;
      let badgeHtml=unreadCounters[uid]?`<span class="badge">${unreadCounters[uid]}</span>`:"";
      row.innerHTML=`<div><span class="status-dot ${u.online?'online':'offline'}"></span>${name} (${gender}) ${badgeHtml}</div>`;
      row.addEventListener('click',()=>openChat(uid,name)); // ✅ open chat on name click
      userList.appendChild(row);
    });
    if(lastFriendUid){ openChat(lastFriendUid,lastFriendName); } // ✅ open last chat by default
  });
}

// Chat logic
function openChat(friendUid,friendName){
  currentChatFriendUid=friendUid; chatWith.textContent=friendName;
  chatModal.style.display="flex"; chatMessages.innerHTML=''; typingIndicator.textContent="";
  unreadCounters[friendUid]=0; updateBadges(); listenTyping(friendUid);
  const chatId=getChatId(currentUserUid,friendUid);
  if(currentChatListener)currentChatListener.off();
  const chatRef=db.ref('chats/'+chatId);
  chatRef.child('members').update({[currentUserUid]:true,[friendUid]:true});
  chatRef.child('messages').once('value',snap=>{
    const msgs=snap.val()||{}; Object.values(msgs).forEach(m=>addMsg(m,m.sender===currentUserUid));
    chatMessages.scrollTop=chatMessages.scrollHeight;
  });
  currentChatListener=chatRef.child('messages');
  currentChatListener.on('child_added',s=>{
    const m=s.val(); if(!m.sender)return; addMsg(m,m.sender===currentUserUid);
  });
}

function addMsg(m,self){
  if(chatMessages.querySelector(`[data-ts="${m.timestamp}"]`))return;
  const d=document.createElement('div');
  d.className=`message ${self?'self':'friend'}`; d.dataset.ts=m.timestamp;
  const t=new Date(m.timestamp).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
  d.innerHTML=`${m.text}<div class="timestamp">${t}</div>`;
  chatMessages.appendChild(d); chatMessages.scrollTop=chatMessages.scrollHeight;
}

chatInput.addEventListener("input",()=>{
  if(!currentChatFriendUid)return;
  db.ref('typing/'+currentChatFriendUid+'/'+currentUserUid).set(true);
  clearTimeout(typingTimeout);
  typingTimeout=setTimeout(()=>db.ref('typing/'+currentChatFriendUid+'/'+currentUserUid).remove(),1000);
});

function listenTyping(friendUid){
  const ref=db.ref('typing/'+currentUserUid+'/'+friendUid);
  ref.on('value',snap=>{
    typingIndicator.textContent=snap.exists()?`${chatWith.textContent} is typing...`:'';
  });
}

function sendMsg(){
  const txt=chatInput.value.trim(); if(!txt||!currentChatFriendUid)return;
  const chatId=getChatId(currentUserUid,currentChatFriendUid);
  const msg={sender:currentUserUid,receiver:currentChatFriendUid,text:txt,timestamp:Date.now()};
  db.ref('chats/'+chatId+'/members').update({[currentUserUid]:true,[currentChatFriendUid]:true});
  db.ref('chats/'+chatId+'/messages').push(msg);
  chatInput.value='';
}
chatInput.addEventListener('keydown',e=>{if(e.key==='Enter'){e.preventDefault();sendMsg();}});
sendBtn.onclick=sendMsg;

function closeChat(){
  if(currentChatFriendUid)db.ref('typing/'+currentChatFriendUid+'/'+currentUserUid).remove();
  chatModal.style.display='none'; currentChatFriendUid=''; typingIndicator.textContent="";
}
function getChatId(a,b){return a<b?a+'_'+b:b+'_'+a;}

db.ref('chats').on('child_added',s=>{
  s.ref.child('messages').on('child_added',m=>{
    const msg=m.val(); if(!msg.sender)return;
    if(msg.receiver===currentUserUid&&msg.sender!==currentChatFriendUid){
      unreadCounters[msg.sender]=(unreadCounters[msg.sender]||0)+1; updateBadges();
    }
  });
});

function updateBadges(){
  document.querySelectorAll('.user-row').forEach(r=>{
    const uid=r.dataset.uid; const badge=r.querySelector('.badge');
    if(unreadCounters[uid]){
      if(badge)badge.textContent=unreadCounters[uid];
      else{const b=document.createElement('span');b.className='badge';b.textContent=unreadCounters[uid];r.querySelector('div').appendChild(b);}
    }else if(badge)badge.remove();
  });
}

// Drag chat
dragElement(chatModal);
function dragElement(el){
  let p1=0,p2=0,p3=0,p4=0; const head=document.getElementById("chatHeader");
  (head||el).onmousedown=e=>{e.preventDefault();p3=e.clientX;p4=e.clientY;document.onmouseup=closeDrag;document.onmousemove=drag;};
  function drag(e){e.preventDefault();p1=p3-e.clientX;p2=p4-e.clientY;p3=e.clientX;p4=e.clientY;el.style.top=(el.offsetTop-p2)+'px';el.style.left=(el.offsetLeft-p1)+'px';}
  function closeDrag(){document.onmouseup=null;document.onmousemove=null;}
}
</script>
</body>
</html>
