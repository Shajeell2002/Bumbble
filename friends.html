<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Bumbble - Friends</title>
<style>
body { font-family: Arial, sans-serif; margin:0; background:#fff; color:#333; display:flex; flex-direction:column; min-height:100vh; }
header { display:flex; justify-content:space-between; align-items:center; padding:20px; background:#ffcb2b; }
header h1 { font-size:24px; }
nav a { margin:0 10px; text-decoration:none; color:#333; font-weight:bold; }
.friends-container { flex:1; max-width:500px; margin:20px auto; padding:20px; border-radius:10px; border:1px solid #ddd; box-shadow:0 2px 8px rgba(0,0,0,0.1); }
.friends-container h2 { text-align:center; margin-bottom:20px; }
#searchBar { width:100%; padding:8px; margin-bottom:15px; border-radius:5px; border:1px solid #ccc; }
.friend-item { display:flex; align-items:center; justify-content:space-between; padding:8px; border-bottom:1px solid #eee; }
.friend-info { display:flex; align-items:center; }
.friend-info img { width:40px; height:40px; border-radius:50%; object-fit:cover; margin-right:10px; }
.status { width:12px; height:12px; border-radius:50%; margin-right:5px; display:inline-block; }
.friend-actions button { padding:5px 10px; border:none; border-radius:5px; cursor:pointer; background:#ffcb2b; font-weight:bold; }
.friend-actions button:hover { background:#f1b800; }
</style>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>
<body>

<header>
  <h1>Bumbble</h1>
  <nav id="navLinks"></nav>
</header>

<div class="friends-container">
  <h2>All Users</h2>
  <input type="text" id="searchBar" placeholder="Search users by name">
  <div id="friendsList"></div>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyBkDyP8KPuQc_knXLH9lhtQWDLb59xRJWs",
  authDomain: "bumbble-c061f.firebaseapp.com",
  databaseURL: "https://bumbble-c061f-default-rtdb.firebaseio.com",
  projectId: "bumbble-c061f",
  storageBucket: "bumbble-c061f.appspot.com",
  messagingSenderId: "213165886981",
  appId: "1:213165886981:web:c18652003444869b1bd66c"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();

const nav = document.getElementById("navLinks");
const friendsList = document.getElementById("friendsList");
const searchBar = document.getElementById("searchBar");

let currentUid = "";
let allUsers = {};
let friendsData = {};

// Setup navigation & auth
auth.onAuthStateChanged(user => {
  if (user && user.emailVerified) {
    currentUid = user.uid;
    nav.innerHTML = `
      <a href="index.html">Home</a>
      <a href="friends.html">Friends</a>
      <a href="stories.html">Stories</a>
      <a href="events.html">Events</a>
      <a href="safety.html">Safety</a>
      <a href="profile.html">Profile</a>
      <a href="#" id="logoutBtn">Logout</a>
    `;
    document.getElementById("logoutBtn").addEventListener("click", ()=> {
      auth.signOut().then(()=>window.location.href="login.html");
    });

    // Load all users & friends
    loadAllUsers();
    loadFriends();
    searchBar.addEventListener("input", filterUsers);
  } else {
    nav.innerHTML = `<a href="index.html">Home</a><a href="login.html">Login</a><a href="signup.html">Sign Up</a>`;
    document.querySelector(".friends-container").innerHTML = "<p>Please login to view users.</p>";
  }
});

// Load all registered users in real-time
function loadAllUsers() {
  db.ref('users').on('value', snapshot => {
    allUsers = snapshot.val() || {};
    renderUsers();
  });
}

// Load current user's friends
function loadFriends() {
  db.ref(`friends/${currentUid}`).on('value', snapshot => {
    friendsData = snapshot.val() || {};
    renderUsers();
  });
}

// Render users list
function renderUsers() {
  friendsList.innerHTML = '';
  Object.keys(allUsers).forEach(uid => {
    if(uid === currentUid) return; // skip self

    const user = allUsers[uid].public;
    if(!user) return;

    const isFriend = friendsData[uid] ? true : false;
    const statusColor = user.online ? "green" : "red";

    const div = document.createElement('div');
    div.className = 'friend-item';

    div.innerHTML = `
      <div class="friend-info">
        <span class="status" style="background:${statusColor}"></span>
        <img src="${user.pic || 'images/profile1.png'}" alt="Profile">
        <span>${user.name}</span>
      </div>
      <div class="friend-actions">
        <button onclick="toggleFriend('${uid}', ${isFriend})">${isFriend ? 'Remove' : 'Add'}</button>
      </div>
    `;
    friendsList.appendChild(div);
  });
}

// Add or remove friend
function toggleFriend(uid, isFriend) {
  if(isFriend) {
    db.ref(`friends/${currentUid}/${uid}`).remove();
  } else {
    db.ref(`friends/${currentUid}/${uid}`).set(true);
  }
}

// Filter users by name
function filterUsers() {
  const term = searchBar.value.toLowerCase();
  const filtered = {};
  Object.keys(allUsers).forEach(uid => {
    if(uid === currentUid) return;
    const user = allUsers[uid].public;
    if(user && user.name.toLowerCase().includes(term)) {
      filtered[uid] = allUsers[uid];
    }
  });

  // Render filtered users
  friendsList.innerHTML = '';
  Object.keys(filtered).forEach(uid => {
    const user = filtered[uid].public;
    const isFriend = friendsData[uid] ? true : false;
    const statusColor = user.online ? "green" : "red";

    const div = document.createElement('div');
    div.className = 'friend-item';
    div.innerHTML = `
      <div class="friend-info">
        <span class="status" style="background:${statusColor}"></span>
        <img src="${user.pic || 'images/profile1.png'}" alt="Profile">
        <span>${user.name}</span>
      </div>
      <div class="friend-actions">
        <button onclick="toggleFriend('${uid}', ${isFriend})">${isFriend ? 'Remove' : 'Add'}</button>
      </div>
    `;
    friendsList.appendChild(div);
  });
}
</script>
</body>
</html>
