<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Bumbble - Friends & Chat</title>
<style>
body {
  font-family: Arial, sans-serif;
  margin: 0;
  background: #fefefe;
  color: #333;
  display: flex;
  min-height: 100vh;
  flex-direction: column;
}
header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px 15px;
  background: #f7c948;
  color: #222;
  font-weight: bold;
}
.container {
  display: flex;
  flex: 1;
  overflow: hidden;
}
#friendsList {
  width: 30%;
  background: #fff8e1;
  border-right: 1px solid #ddd;
  overflow-y: auto;
}
#chatContainer {
  flex: 1;
  display: flex;
  flex-direction: column;
}
.user-row {
  padding: 10px;
  border-bottom: 1px solid #eee;
  display: flex;
  justify-content: space-between;
  cursor: pointer;
  align-items: center;
  transition: background 0.3s;
}
.user-row:hover {
  background: #ffecb3;
}
.user-row.flash {
  background: #ffe082 !important;
  transition: background 0.5s;
}
.badge {
  background: red;
  color: white;
  border-radius: 10px;
  padding: 2px 7px;
  font-size: 12px;
  margin-left: 8px;
}
#messages {
  flex: 1;
  padding: 10px;
  overflow-y: auto;
  background: #fff;
}
.message {
  margin: 5px 0;
  padding: 8px 12px;
  border-radius: 10px;
  max-width: 70%;
}
.sent {
  background: #e0f7fa;
  align-self: flex-end;
}
.received {
  background: #f1f8e9;
  align-self: flex-start;
}
#inputArea {
  display: flex;
  padding: 10px;
  background: #fafafa;
  border-top: 1px solid #ddd;
}
#inputArea input[type="text"] {
  flex: 1;
  padding: 8px;
  border: 1px solid #ccc;
  border-radius: 4px;
}
#inputArea button {
  margin-left: 8px;
  padding: 8px 15px;
  border: none;
  background: #f7c948;
  border-radius: 4px;
  cursor: pointer;
  font-weight: bold;
}
</style>
</head>
<body>

<header>
  <span>Bumbble Friends</span>
  <button id="logoutBtn">Logout</button>
</header>

<div class="container">
  <div id="friendsList"></div>

  <div id="chatContainer">
    <div id="messages"></div>
    <div id="inputArea">
      <input id="messageInput" type="text" placeholder="Type a message..." />
      <button id="sendBtn">Send</button>
    </div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>

<script>
// ==== Firebase Config ====
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_DOMAIN",
  databaseURL: "YOUR_DB_URL",
  projectId: "YOUR_PROJECT_ID",
  storageBucket: "YOUR_BUCKET",
  messagingSenderId: "YOUR_SENDER_ID",
  appId: "YOUR_APP_ID"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// ==== Global State ====
let currentUserUid = null;
let currentChatFriendUid = null;
let unreadCounters = {};
let lastChatTimestamps = {};
let friends = [];

// ==== Auth ====
firebase.auth().onAuthStateChanged(user => {
  if (user) {
    currentUserUid = user.uid;
    loadUsersRealtime();
    listenUnreadMessages();
  } else {
    window.location.href = "login.html";
  }
});

document.getElementById("logoutBtn").addEventListener("click", () => {
  firebase.auth().signOut();
});

// ==== Load Friend List ====
function loadUsersRealtime() {
  db.ref("users").on("value", snapshot => {
    const usersData = snapshot.val() || {};
    friends = [];

    Object.keys(usersData).forEach(uid => {
      if (uid === currentUserUid) return;
      const u = usersData[uid].public || {};
      friends.push({
        uid,
        name: u.name || "Unknown",
        gender: u.gender || "N/A",
        lastActive: lastChatTimestamps[uid] || 0
      });
    });
    renderFriendList();
  });
}

// ==== Render Friend List ====
function renderFriendList() {
  const list = document.getElementById("friendsList");
  list.innerHTML = "";
  const sorted = friends.sort((a, b) => (lastChatTimestamps[b.uid] || 0) - (lastChatTimestamps[a.uid] || 0));

  sorted.forEach(u => {
    const row = document.createElement("div");
    row.className = "user-row";
    row.dataset.uid = u.uid;
    row.innerHTML = `
      <div>${u.name}</div>
      ${unreadCounters[u.uid] ? `<span class="badge">${unreadCounters[u.uid]}</span>` : ""}
    `;
    row.addEventListener("click", () => openChat(u.uid, u.name));
    list.appendChild(row);
  });
}

// ==== Open Chat ====
function openChat(uid, name) {
  currentChatFriendUid = uid;
  document.getElementById("messages").innerHTML = "";
  unreadCounters[uid] = 0;
  renderFriendList();

  const chatId = getChatId(currentUserUid, uid);
  db.ref("chats/" + chatId + "/messages").off();

  db.ref("chats/" + chatId + "/messages").on("child_added", snap => {
    const msg = snap.val();
    if (!msg) return;
    displayMessage(msg);
  });
}

// ==== Display Message ====
function displayMessage(msg) {
  const messagesDiv = document.getElementById("messages");
  const div = document.createElement("div");
  div.className = `message ${msg.sender === currentUserUid ? "sent" : "received"}`;
  div.textContent = msg.text;
  messagesDiv.appendChild(div);
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

// ==== Send Message ====
document.getElementById("sendBtn").addEventListener("click", sendMessage);

function sendMessage() {
  const input = document.getElementById("messageInput");
  const text = input.value.trim();
  if (!text || !currentChatFriendUid) return;
  input.value = "";

  const chatId = getChatId(currentUserUid, currentChatFriendUid);
  const msg = {
    sender: currentUserUid,
    receiver: currentChatFriendUid,
    text,
    timestamp: Date.now()
  };
  db.ref("chats/" + chatId + "/messages").push(msg);
  lastChatTimestamps[currentChatFriendUid] = msg.timestamp;
  reorderFriendList();
}

// ==== Listen for Incoming Messages ====
function listenUnreadMessages() {
  db.ref("chats").on("child_added", snap => {
    const chatRef = snap.ref.child("messages");
    chatRef.on("child_added", msgSnap => {
      const msg = msgSnap.val();
      if (!msg || !msg.sender || !msg.receiver) return;

      // Only process if current user is receiver
      if (msg.receiver === currentUserUid) {
        // Increase unread if not active chat
        if (msg.sender !== currentChatFriendUid) {
          unreadCounters[msg.sender] = (unreadCounters[msg.sender] || 0) + 1;
        }
        lastChatTimestamps[msg.sender] = msg.timestamp;
        renderFriendList();
        flashUserRow(msg.sender);
      }
    });
  });
}

// ==== Helpers ====
function flashUserRow(uid) {
  const row = document.querySelector(`.user-row[data-uid="${uid}"]`);
  if (row) {
    row.classList.add("flash");
    setTimeout(() => row.classList.remove("flash"), 1000);
  }
}

function reorderFriendList() {
  renderFriendList();
}

function getChatId(uid1, uid2) {
  return uid1 < uid2 ? uid1 + "_" + uid2 : uid2 + "_" + uid1;
}
</script>
</body>
</html>
