<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Bumbble - Friends & Chat</title>
<style>
/* --- Your existing CSS unchanged --- */
body { font-family: Arial, sans-serif; margin:0; background:#f8f6fb; color:#333; display:flex; min-height:100vh; flex-direction: column; }
/* ... rest of CSS unchanged ... */
</style>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<!-- NSFWJS -->
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.8.0/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/nsfwjs@2.4.0/dist/nsfwjs.min.js"></script>

</head>
<body>

<header>
  <h1>Bumbble</h1>
  <nav id="navLinks">
    <a href="index.html">Home</a>
    <a href="login.html">Login</a>
    <a href="signup.html">Sign Up</a>
  </nav>
</header>

<div class="friends-container">
  <div class="user-list" id="userList"></div>
</div>

<div class="main-content">
  <div id="chatModal">
    <div id="chatHeader">
      <span id="chatWith">Friend</span>
      <button onclick="closeChat()">X</button>
    </div>
    <div id="chatMessages"></div>
    <div id="typingIndicator"></div>
    <div id="chatInputContainer">
      <button id="fileBtn">ðŸ“Ž</button>
      <input type="text" id="chatInput" placeholder="Type a message">
      <button id="sendBtn">Send</button>
      <input type="file" id="chatFileInput" style="display:none;" multiple>
    </div>
  </div>
  <div id="errorArea"></div>
</div>

<script>
// --- Firebase Init ---
const firebaseConfig = {
  apiKey:"AIzaSyBkDyP8KPuQc_knXLH9lhtQWDLb59xRJWs",
  authDomain:"bumbble-c061f.firebaseapp.com",
  databaseURL:"https://bumbble-c061f-default-rtdb.firebaseio.com",
  projectId:"bumbble-c061f",
  storageBucket:"bumbble-c061f.appspot.com",
  messagingSenderId:"213165886981",
  appId:"1:213165886981:web:c18652003444869b1bd66c"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();

// --- DOM ---
const nav = document.getElementById("navLinks");
const userList = document.getElementById("userList");
const chatModal = document.getElementById("chatModal");
const chatMessages = document.getElementById("chatMessages");
const chatWith = document.getElementById("chatWith");
const chatInput = document.getElementById("chatInput");
const sendBtn = document.getElementById("sendBtn");
const fileBtn = document.getElementById("fileBtn");
const chatFileInput = document.getElementById("chatFileInput");
const typingIndicator = document.getElementById("typingIndicator");
const errorArea = document.getElementById("errorArea");

let currentUserUid = "", currentChatFriendUid = "", currentChatListener = null;
let unreadCounters = {}, lastChatTimestamps = {}, typingTimeout;
let nsfwModel = null;

// --- Load NSFW Model ---
(async ()=>{
  nsfwModel = await nsfwjs.load();
  console.log("NSFWJS model loaded.");
})();

// --- Error Handling ---
window.addEventListener('error', e=>{ showError(e.message || e); });
function showError(msg){ errorArea.innerHTML = '<div class="error-banner">'+escapeHtml(msg)+'</div>'; }

// --- NSFW Check ---
async function checkImageNSFW(file){
  if(!nsfwModel) {
    showError("NSFW model not ready. Try again in a few seconds.");
    return false;
  }

  return new Promise((resolve)=>{
    const reader = new FileReader();
    reader.onload = async e=>{
      const img = new Image();
      img.src = e.target.result;
      img.onload = async ()=>{
        const predictions = await nsfwModel.classify(img);
        const nsfwScore = predictions
          .filter(p=>["Porn","Hentai","Sexy"].includes(p.className))
          .reduce((acc,p)=>acc+p.probability,0);
        if(nsfwScore > 0.2){ // Threshold: block if NSFW probability >20%
          resolve(false);
        } else resolve(true);
      };
    };
    reader.readAsDataURL(file);
  });
}

// --- Rest of your chat code ---
// Auth, online status, users list, unread messages, chat open, send message, typing, close chat
// (Keep all your existing functional code here unchanged)

// --- File Upload with real NSFW check ---
fileBtn.onclick=()=>chatFileInput.click();
chatFileInput.addEventListener('change', async e=>{
  for(const f of e.target.files){
    if(!currentChatFriendUid) continue;

    const allowed = await checkImageNSFW(f);
    if(!allowed){
      showError("NSFW image blocked. Upload normal images only.");
      continue;
    }

    const chatId=getChatId(currentUserUid,currentChatFriendUid);
    const tempMsgRef=db.ref('chats/'+chatId+'/messages').push({
      sender:currentUserUid,
      receiver:currentChatFriendUid,
      uploading:true,
      fileName:f.name,
      timestamp:Date.now()
    });

    const reader=new FileReader();
    reader.onload=function(ev){
      const data=ev.target.result;
      tempMsgRef.update({ uploading:false, fileData:data, fileType:f.type });
      db.ref('unread/'+currentChatFriendUid+'/'+currentUserUid+'/'+tempMsgRef.key).set(true);
    };
    reader.readAsDataURL(f);
  }
});

// --- Helper Functions ---
function getChatId(a,b){ return a<b? a+'_'+b : b+'_'+a; }
function escapeHtml(str){ return str.replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
function closeChat(){ chatModal.style.display='none'; currentChatFriendUid=null; if(currentChatListener) currentChatListener.off(); }

// --- Resizable chat modal, typing, message rendering, etc. ---
// Keep your existing code unchanged
</script>
</body>
</html>
