<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Bumbble - Friends & Chat</title>
<style>
body {
  font-family: Arial, sans-serif;
  margin: 0;
  background: #f8f6fb;
  color: #333;
  display: flex;
  min-height: 100vh;
  flex-direction: column;
}
header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 15px 20px;
  background: #d8cce5;
  box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1);
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  z-index: 500;
}
header h1 { font-size: 24px; margin: 0; }
nav a { margin-left: 10px; font-weight: bold; color: #333; text-decoration: none; }
.friends-container {
  width: 250px;
  background: #e6e0f0;
  border-right: 1px solid #ccc;
  padding: 10px;
  overflow-y: auto;
  position: fixed;
  top: 60px;
  bottom: 0;
  left: 0;
}
.main-content {
  flex: 1;
  margin-left: 250px;
  padding: 80px 20px 20px 20px;
}
.user-list {
  display: flex;
  flex-direction: column;
  gap: 2px;
  font-size: 14px;
}
.user-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 6px 8px;
  border-bottom: 1px solid #ccc;
  cursor: pointer;
  transition: 0.2s;
}
.user-row:hover, .user-row.active { background: #ddd6f3; }
.user-row.flash { animation: flashLavender 0.5s; }
@keyframes flashLavender { 0%{background:#e0b3ff;} 100%{background:#ddd6f3;} }
.status-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 6px; }
.online { background: green; } .offline { background: red; }
.badge {
  background: #9b59b6; color: white; font-size: 10px; font-weight: bold;
  padding: 1px 5px; border-radius: 10px; margin-left: 6px;
}
#chatModal {
  position: fixed;
  bottom: 0;
  right: 20px;
  width: 360px;
  height: 500px;
  max-height: 70vh;
  min-width: 300px;
  min-height: 250px;
  resize: both;
  overflow: auto;
  border: 1px solid #ccc;
  background: #d8cce5;
  border-radius: 10px 10px 0 0;
  display: none;
  flex-direction: column;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
  z-index: 1000;
}
#chatHeader {
  background: #d8cce5;
  padding: 10px;
  font-weight: bold;
  display: flex;
  justify-content: space-between;
  align-items: center;
  border-radius: 10px 10px 0 0;
  cursor: move;
}
#chatMessages {
  flex: 1;
  padding: 10px;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  gap: 8px;
  background: #f8f6fb;
  scroll-behavior: smooth;
}
#typingIndicator { font-size: 12px; color: #555; padding-left: 10px; height: 18px; }
.message { max-width: 80%; padding: 8px 10px; border-radius: 10px; position: relative; word-wrap: break-word; }
.message.self { background: #9b59b6; color: white; align-self: flex-end; }
.message.friend { background: #ece6f2; color: #111; align-self: flex-start; }
.timestamp { font-size: 10px; color: #666; margin-top: 6px; text-align: right; display: block; }
.uploading-badge { font-size: 11px; color: #444; margin-top: 6px; background: #e6e0f0; padding: 3px 6px; border-radius: 6px; border: 1px solid #d0c4e0; display:inline-block; }
#chatInputContainer { display: flex; border-top: 1px solid #ccc; align-items: center; gap: 6px; padding: 8px; background: #e6e0f0; }
#chatInput { flex: 1; padding: 8px; border: none; outline: none; border-radius: 8px; background: #f0e6fa; }
#sendBtn, #fileBtn {
  padding: 8px 12px;
  border: none;
  background: #b39ddb;
  cursor: pointer;
  border-radius: 8px;
  color: white;
  font-weight: bold;
}
#sendBtn:hover, #fileBtn:hover { background: #9775c2; }
.friends-container::-webkit-scrollbar { width: 6px; }
.friends-container::-webkit-scrollbar-thumb { background: #b39ddb; border-radius: 3px; }
.friends-container::-webkit-scrollbar-track { background: #f0e6fa; }
.error-banner { background: #f2e6ff; color: #800; padding: 8px 12px; border: 1px solid #d8b3ff; margin: 10px; border-radius: 6px; }
.chat-image { max-width: 100%; height: auto; display: block; margin-top: 4px; border-radius: 6px; }
</style>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>
<body>

<header>
  <h1>Bumbble</h1>
  <nav id="navLinks">
    <a href="index.html">Home</a>
    <a href="login.html">Login</a>
    <a href="signup.html">Sign Up</a>
  </nav>
</header>

<div class="friends-container">
  <div class="user-list" id="userList"></div>
</div>

<div class="main-content">
  <div id="chatModal">
    <div id="chatHeader">
      <span id="chatWith">Friend</span>
      <button onclick="closeChat()">X</button>
    </div>
    <div id="chatMessages"></div>
    <div id="typingIndicator"></div>
    <div id="chatInputContainer">
      <button id="fileBtn">üìé</button>
      <input type="text" id="chatInput" placeholder="Type a message">
      <button id="sendBtn">Send</button>
      <input type="file" id="chatFileInput" style="display:none;" multiple>
    </div>
  </div>
  <div id="errorArea"></div>
</div>

<script>
const firebaseConfig = {
  apiKey:"AIzaSyBkDyP8KPuQc_knXLH9lhtQWDLb59xRJWs",
  authDomain:"bumbble-c061f.firebaseapp.com",
  databaseURL:"https://bumbble-c061f-default-rtdb.firebaseio.com",
  projectId:"bumbble-c061f",
  storageBucket:"bumbble-c061f.appspot.com",
  messagingSenderId:"213165886981",
  appId:"1:213165886981:web:c18652003444869b1bd66c"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();

const userList = document.getElementById("userList");
const chatModal = document.getElementById("chatModal");
const chatMessages = document.getElementById("chatMessages");
const chatWith = document.getElementById("chatWith");
const chatInput = document.getElementById("chatInput");
const sendBtn = document.getElementById("sendBtn");
const fileBtn = document.getElementById("fileBtn");
const chatFileInput = document.getElementById("chatFileInput");
const typingIndicator = document.getElementById("typingIndicator");
const errorArea = document.getElementById("errorArea");
const nav = document.getElementById("navLinks");

let currentUserUid="", currentChatFriendUid="", currentChatListener=null;
let unreadCounters={}, typingTimeout;

auth.onAuthStateChanged(user=>{
  if(user && user.emailVerified){
    currentUserUid=user.uid;
    nav.innerHTML=`<a href="index.html">Home</a><a href="friends.html">Friends</a><a href="profile.html">Profile</a><a href="#" id="logoutBtn">Logout</a>`;
    document.getElementById("logoutBtn").addEventListener("click",()=>auth.signOut());
    setupOnlineStatus(); loadUsersRealtime(); setupUnreadListener();
  } else {
    nav.innerHTML=`<a href="index.html">Home</a><a href="login.html">Login</a><a href="signup.html">Sign Up</a>`;
  }
});

function setupOnlineStatus(){
  if(!currentUserUid)return;
  const ref=db.ref('users/'+currentUserUid+'/public/online');
  db.ref('.info/connected').on('value',snap=>{
    if(snap.val()===true){ ref.set(true); ref.onDisconnect().set(false); }
  });
}

function loadUsersRealtime(){
  db.ref('users').on('value',snap=>{
    const users=snap.val()||{};
    const list=Object.keys(users).filter(u=>u!==currentUserUid).map(uid=>{
      const p=users[uid].public||{};
      return {uid,name:p.name||"Unknown",online:!!p.online};
    });
    userList.innerHTML="";
    list.forEach(u=>{
      const row=document.createElement('div');
      row.className='user-row';
      row.dataset.uid=u.uid;
      row.innerHTML=`<div><span class="status-dot ${u.online?'online':'offline'}"></span>${u.name}</div>`;
      row.onclick=()=>openChat(u.uid,u.name);
      userList.appendChild(row);
    });
    updateFriendListBadges();
  });
}

function setupUnreadListener(){
  db.ref('unread/'+currentUserUid).on('value',snap=>{
    unreadCounters={};
    const data=snap.val()||{};
    Object.keys(data).forEach(uid=>{
      unreadCounters[uid]=Object.keys(data[uid]||{}).length;
    });
    updateFriendListBadges();
  });
}
function updateFriendListBadges(){
  document.querySelectorAll('.user-row').forEach(row=>{
    const uid=row.dataset.uid;
    const count=unreadCounters[uid]||0;
    let badge=row.querySelector('.badge');
    if(count>0){
      if(!badge){ badge=document.createElement('span'); badge.className='badge'; row.querySelector('div').appendChild(badge); }
      badge.textContent=count;
    } else if(badge) badge.remove();
  });
}

function openChat(uid,name){
  currentChatFriendUid=uid;
  chatWith.textContent=name;
  chatModal.style.display='flex';
  chatMessages.innerHTML="";
  typingIndicator.textContent="";
  db.ref('unread/'+currentUserUid+'/'+uid).remove();

  const chatId=getChatId(currentUserUid,uid);
  if(currentChatListener) currentChatListener.off();
  const ref=db.ref('chats/'+chatId+'/messages');
  ref.on('child_added',snap=>addMessage(snap.key,snap.val()));
  currentChatListener=ref;
}

function addMessage(key,msg){
  const isSelf=(msg.sender===currentUserUid);
  const el=document.createElement('div');
  el.className='message '+(isSelf?'self':'friend');
  if(msg.fileData){
    if(msg.fileType.includes('image'))
      el.innerHTML=`<img class="chat-image" src="${msg.fileData}"><span class="timestamp">${new Date(msg.timestamp).toLocaleString()}</span>`;
    else el.innerHTML=`<a href="${msg.fileData}" download="${msg.fileName}">‚¨áÔ∏è ${msg.fileName}</a>`;
  } else if(msg.text){
    el.innerHTML=msg.text+`<div class="timestamp">${new Date(msg.timestamp).toLocaleString()}</div>`;
  }
  chatMessages.appendChild(el);
  chatMessages.scrollTop=chatMessages.scrollHeight;
}

sendBtn.onclick=sendMessage;
chatInput.addEventListener('keydown',e=>{ if(e.key==='Enter')sendMessage(); });

function sendMessage(){
  const text=chatInput.value.trim();
  if(!text||!currentChatFriendUid)return;
  const chatId=getChatId(currentUserUid,currentChatFriendUid);
  db.ref('chats/'+chatId+'/messages').push({
    sender:currentUserUid,receiver:currentChatFriendUid,text, timestamp:Date.now()
  });
  chatInput.value="";
}

// -------- Image resize before upload ----------
fileBtn.onclick=()=>chatFileInput.click();
chatFileInput.onchange=async function(){
  if(!this.files.length||!currentChatFriendUid)return;
  for(const file of this.files){
    let dataUrl=await resizeImage(file,256*1024);
    const chatId=getChatId(currentUserUid,currentChatFriendUid);
    db.ref('chats/'+chatId+'/messages').push({
      sender:currentUserUid,receiver:currentChatFriendUid,
      fileData:dataUrl,fileType:file.type,fileName:file.name,timestamp:Date.now()
    });
  }
  this.value="";
};

async function resizeImage(file,maxSize){
  return new Promise(resolve=>{
    if(!file.type.startsWith('image/')){
      const reader=new FileReader();
      reader.onload=e=>resolve(e.target.result);
      reader.readAsDataURL(file);
      return;
    }
    const reader=new FileReader();
    reader.onload=e=>{
      const img=new Image();
      img.onload=()=>{
        const canvas=document.createElement('canvas');
        const ctx=canvas.getContext('2d');
        let w=img.width,h=img.height;
        const maxDim=800;
        if(w>h&&w>maxDim){ h*=maxDim/w; w=maxDim; }
        else if(h>w&&h>maxDim){ w*=maxDim/h; h=maxDim; }
        canvas.width=w; canvas.height=h;
        ctx.drawImage(img,0,0,w,h);
        let quality=0.9, result=canvas.toDataURL('image/jpeg',quality);
        while(result.length>maxSize && quality>0.2){
          quality-=0.1;
          result=canvas.toDataURL('image/jpeg',quality);
        }
        resolve(result);
      };
      img.src=e.target.result;
    };
    reader.readAsDataURL(file);
  });
}
// ------------------------------------------------

function closeChat(){ chatModal.style.display='none'; if(currentChatListener){ currentChatListener.off(); currentChatListener=null; } }

function getChatId(a,b){ return [a,b].sort().join('_'); }

// Drag to move
const chatHeader=document.getElementById('chatHeader');
let drag=false,offX,offY;
chatHeader.addEventListener('mousedown',e=>{
  if(e.target.tagName==='BUTTON')return;
  drag=true;const r=chatModal.getBoundingClientRect();
  offX=e.clientX-r.left; offY=e.clientY-r.top;
});
document.addEventListener('mouseup',()=>drag=false);
document.addEventListener('mousemove',e=>{
  if(!drag)return;
  let l=e.clientX-offX,t=e.clientY-offY;
  l=Math.max(0,Math.min(l,window.innerWidth-chatModal.offsetWidth));
  t=Math.max(0,Math.min(t,window.innerHeight-chatModal.offsetHeight));
  chatModal.style.left=l+'px'; chatModal.style.top=t+'px';
});
</script>
</body>
</html>
