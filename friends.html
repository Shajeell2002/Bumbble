<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Bumbble - Friends</title>
<style>
body { font-family: Arial,sans-serif; background:#fff; color:#333; margin:0; display:flex; flex-direction:column; min-height:100vh; }
header { display:flex; justify-content:space-between; align-items:center; padding:20px; background:#ffcb2b; }
header h1 { font-size:24px; }
nav a { margin:0 10px; text-decoration:none; color:#333; font-weight:bold; }
.friends-container { flex:1; max-width:600px; margin:30px auto; padding:20px; border-radius:10px; border:1px solid #ddd; box-shadow:0 2px 8px rgba(0,0,0,0.1); }
.friends-container h2 { text-align:center; margin-bottom:20px; }
.friend-item { display:flex; justify-content:space-between; align-items:center; padding:8px; border-bottom:1px solid #ccc; }
.friend-item:last-child { border-bottom:none; }
.friend-status { width:12px; height:12px; border-radius:50%; display:inline-block; margin-right:8px; }
button { padding:5px 10px; background:#ffcb2b; border:none; border-radius:5px; cursor:pointer; font-weight:bold; }
button:hover { background:#f1b800; }
input[type=text] { width:calc(100% - 100px); padding:8px; margin-bottom:10px; border:1px solid #ccc; border-radius:5px; }
.search-container { display:flex; align-items:center; margin-bottom:10px; }
.error-msg { color:red; font-size:14px; margin-top:5px; text-align:center; }
</style>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>
<body>

<header>
  <h1>Bumbble</h1>
  <nav id="navLinks"></nav>
</header>

<div class="friends-container">
  <h2>Your Friends</h2>

  <div class="search-container">
    <input type="text" id="searchUser" placeholder="Search by name">
    <button onclick="searchUser()">Search</button>
  </div>
  <div id="searchResults"></div>

  <h3>Friends List</h3>
  <div id="friendsList"></div>

  <p class="error-msg" id="errorMsg"></p>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyBkDyP8KPuQc_knXLH9lhtQWDLb59xRJWs",
  authDomain: "bumbble-c061f.firebaseapp.com",
  databaseURL: "https://bumbble-c061f-default-rtdb.firebaseio.com",
  projectId: "bumbble-c061f",
  storageBucket: "bumbble-c061f.appspot.com",
  messagingSenderId: "213165886981",
  appId: "1:213165886981:web:c18652003444869b1bd66c"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();

const nav = document.getElementById("navLinks");
const friendsList = document.getElementById("friendsList");
const errorMsg = document.getElementById("errorMsg");
const searchResults = document.getElementById("searchResults");
const searchInput = document.getElementById("searchUser");

let currentUid = null;

// Navigation & auth
auth.onAuthStateChanged(user => {
  if(user && user.emailVerified){
    currentUid = user.uid;
    nav.innerHTML = `
      <a href="index.html">Home</a>
      <a href="friends.html">Friends</a>
      <a href="stories.html">Stories</a>
      <a href="events.html">Events</a>
      <a href="safety.html">Safety</a>
      <a href="profile.html">Profile</a>
      <a href="#" id="logoutBtn">Logout</a>
    `;
    document.getElementById("logoutBtn").addEventListener("click", ()=>{
      auth.signOut().then(()=>window.location.href="login.html");
    });
    loadFriends(currentUid);
  } else {
    nav.innerHTML = `<a href="index.html">Home</a><a href="login.html">Login</a><a href="signup.html">Sign Up</a>`;
    document.querySelector(".friends-container").innerHTML = "<p>Please login to view your friends.</p>";
  }
});

// Realtime friends list
function loadFriends(uid){
  db.ref(`friends/${uid}`).on('value', snapshot => {
    const friends = snapshot.val() || {};
    friendsList.innerHTML = '';
    if(Object.keys(friends).length === 0){
      friendsList.innerHTML = '<p>No friends added yet.</p>';
      return;
    }
    for(const fUid in friends){
      db.ref(`users/${fUid}/public`).on('value', snap=>{
        const f = snap.val() || {};
        const div = document.createElement('div');
        div.className = 'friend-item';
        const onlineStatus = f.online ? 'green' : 'red';
        div.innerHTML = `
          <span><span class="friend-status" style="background:${onlineStatus}"></span>${f.name || "Unnamed"} (${f.age||"N/A"})</span>
          <button onclick="removeFriend('${fUid}')">Remove</button>
        `;
        friendsList.appendChild(div);
      });
    }
  });
}

// Remove friend
function removeFriend(friendUid){
  db.ref(`friends/${currentUid}/${friendUid}`).remove()
    .then(()=>alert("Friend removed"))
    .catch(err=>{ console.error(err); errorMsg.textContent="Failed to remove friend."; });
}

// Search users
function searchUser(){
  const query = searchInput.value.trim().toLowerCase();
  if(!query) return;

  db.ref('users').once('value').then(snapshot=>{
    const users = snapshot.val() || {};
    searchResults.innerHTML = '';
    let found = false;
    for(const uid in users){
      if(uid === currentUid) continue; // skip self
      const name = users[uid].public?.name?.toLowerCase() || '';
      if(name.includes(query)){
        found = true;
        const userDiv = document.createElement('div');
        const onlineStatus = users[uid].public?.online ? 'green' : 'red';
        const isFriend = users[currentUid]?.friends?.[uid] !== undefined;
        userDiv.className = 'friend-item';
        userDiv.innerHTML = `
          <span><span class="friend-status" style="background:${onlineStatus}"></span>${users[uid].public?.name || "Unnamed"}</span>
          <button ${isFriend ? 'disabled' : ''} onclick="addFriend('${uid}')">${isFriend ? 'Added' : 'Add'}</button>
        `;
        searchResults.appendChild(userDiv);
      }
    }
    if(!found) searchResults.innerHTML = '<p>No users found.</p>';
  });
}

// Add friend
function addFriend(friendUid){
  db.ref(`friends/${currentUid}/${friendUid}`).set(true)
    .then(()=>{ alert("Friend added!"); searchUser(); })
    .catch(err=>{ console.error(err); errorMsg.textContent="Failed to add friend."; });
}
</script>
</body>
</html>
