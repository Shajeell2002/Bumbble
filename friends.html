<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Bumbble - Friends</title>
<style>
body {font-family: Arial,sans-serif; background:#fff; color:#333; margin:0; padding:0;}
header {display:flex; justify-content:space-between; align-items:center; padding:20px; background:#ffcb2b;}
header h1 {font-size:24px;}
nav a {margin:0 10px; text-decoration:none; color:#333; font-weight:bold;}
.container {max-width:600px; margin:40px auto; padding:20px; background:#f9f9f9; border-radius:15px; box-shadow:0 2px 6px rgba(0,0,0,0.1);}
h2 {margin-top:30px;}
.user, .friend {display:flex; align-items:center; justify-content:space-between; padding:10px; border-bottom:1px solid #ddd;}
.user img, .friend img {width:50px; height:50px; border-radius:50%; object-fit:cover; margin-right:15px;}
button {padding:6px 12px; border:none; border-radius:5px; cursor:pointer;}
.add {background:#4CAF50; color:#fff;}
.remove {background:#f44336; color:#fff;}
</style>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>
<body>

<header>
<h1>Bumbble</h1>
<nav id="navLinks"></nav>
</header>

<div class="container" id="friendsContainer">
<h2>Your Friends</h2>
<div id="friendList">Loading...</div>

<h2>All Users</h2>
<div id="allUsersList">Loading...</div>
</div>

<script>
const nav = document.getElementById("navLinks");
const friendListDiv = document.getElementById("friendList");
const allUsersListDiv = document.getElementById("allUsersList");

const firebaseConfig = {
  apiKey: "AIzaSyBkDyP8KPuQc_knXLH9lhtQWDLb59xRJWs",
  authDomain: "bumbble-c061f.firebaseapp.com",
  databaseURL: "https://bumbble-c061f-default-rtdb.firebaseio.com",
  projectId: "bumbble-c061f",
  storageBucket: "bumbble-c061f.appspot.com",
  messagingSenderId: "213165886981",
  appId: "1:213165886981:web:c18652003444869b1bd66c"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();

auth.onAuthStateChanged(user => {
  if (!user || !user.emailVerified) {
    nav.innerHTML = `<a href="index.html">Home</a>
                     <a href="login.html">Login</a>
                     <a href="signup.html">Sign Up</a>`;
    friendListDiv.innerHTML = "<p>Please login to view friends.</p>";
    allUsersListDiv.innerHTML = "";
    return;
  }

  const uid = user.uid;

  nav.innerHTML = `
    <a href="index.html">Home</a>
    <a href="friends.html">Friends</a>
    <a href="stories.html">Stories</a>
    <a href="events.html">Events</a>
    <a href="safety.html">Safety</a>
    <a href="profile.html">Profile</a>
    <a href="#" id="logoutBtn">Logout</a>
  `;
  document.getElementById("logoutBtn").addEventListener("click", ()=> auth.signOut().then(()=> window.location.href="login.html"));

  const usersRef = db.ref("users");
  const friendsRef = db.ref("friends/" + uid);

  let currentFriends = {};

  friendsRef.on("value", snapshot => {
    currentFriends = snapshot.val() || {};
    renderLists();
  });

  function renderLists() {
    usersRef.once("value").then(snapshot => {
      const users = snapshot.val() || {};
      friendListDiv.innerHTML = "";
      allUsersListDiv.innerHTML = "";

      for (let otherUid in users) {
        if (otherUid === uid) continue;

        const u = users[otherUid];
        const isFriend = !!currentFriends[otherUid];

        const div = document.createElement("div");
        div.classList.add(isFriend ? "friend" : "user");
        div.innerHTML = `
          <div style="display:flex; align-items:center;">
            <img src="${u.pic || 'images/profile1.png'}" alt="Profile">
            <span>${u.name || 'Unnamed'}</span>
          </div>
          <button class="${isFriend?'remove':'add'}">${isFriend?'Remove':'Add'}</button>
        `;

        div.querySelector("button").addEventListener("click", () => {
          if (isFriend) {
            db.ref(`friends/${uid}/${otherUid}`).remove();
            db.ref(`friends/${otherUid}/${uid}`).remove();
          } else {
            db.ref(`friends/${uid}/${otherUid}`).set(true);
            db.ref(`friends/${otherUid}/${uid}`).set(true);
          }
        });

        if (isFriend) friendListDiv.appendChild(div);
        else allUsersListDiv.appendChild(div);
      }

      if (!Object.keys(currentFriends).length) friendListDiv.innerHTML = "<p>No friends yet.</p>";
      if (!Object.keys(users).filter(u => u !== uid && !currentFriends[u]).length) allUsersListDiv.innerHTML = "<p>All users are already your friends.</p>";
    });
  }
});
</script>
</body>
</html>
