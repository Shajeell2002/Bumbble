<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bumbble - Friends & Chat</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      background: #fefefe;
      color: #333;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    header {
      background: #ffb300;
      color: #fff;
      padding: 10px;
      font-size: 20px;
      text-align: center;
    }
    .container {
      display: flex;
      flex: 1;
      overflow: hidden;
    }
    .friends-list {
      width: 30%;
      border-right: 1px solid #ddd;
      overflow-y: auto;
      background: #fff;
    }
    .chat-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: #f8f8f8;
    }
    .user-row {
      padding: 12px 15px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid #eee;
      cursor: pointer;
    }
    .user-row:hover {
      background: #f1f1f1;
    }
    .user-name {
      font-weight: 600;
    }
    .badge {
      background: red;
      color: #fff;
      border-radius: 10px;
      padding: 2px 7px;
      font-size: 12px;
      margin-left: 8px;
    }
    .chat-box {
      flex: 1;
      padding: 10px;
      overflow-y: auto;
    }
    .chat-message {
      margin: 6px 0;
      max-width: 70%;
      padding: 8px 12px;
      border-radius: 12px;
      line-height: 1.4;
    }
    .sent {
      background: #d1f7d6;
      align-self: flex-end;
    }
    .received {
      background: #fff;
      align-self: flex-start;
      border: 1px solid #ddd;
    }
    .chat-input {
      display: flex;
      border-top: 1px solid #ccc;
      padding: 8px;
      background: #fff;
    }
    .chat-input input {
      flex: 1;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 6px;
      margin-right: 8px;
    }
    .chat-input button {
      padding: 10px 14px;
      border: none;
      background: #ffb300;
      color: #fff;
      border-radius: 6px;
      cursor: pointer;
    }
    .chat-input button:hover {
      background: #e6a100;
    }
    .flash {
      background: #ffe3e3 !important;
      transition: background 0.5s;
    }
  </style>
</head>
<body>
  <header>Bumbble - Friends & Chat</header>
  <div class="container">
    <div class="friends-list" id="friendsList"></div>
    <div class="chat-area">
      <div class="chat-box" id="chatBox"></div>
      <div class="chat-input">
        <input type="text" id="messageInput" placeholder="Type a message..." />
        <button id="sendBtn">Send</button>
      </div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>

  <!-- REPLACE YOUR <script> ... </script> WITH THIS BLOCK -->
<script>
const firebaseConfig = { apiKey:"AIzaSyBkDyP8KPuQc_knXLH9lhtQWDLb59xRJWs", authDomain:"bumbble-c061f.firebaseapp.com", databaseURL:"https://bumbble-c061f-default-rtdb.firebaseio.com", projectId:"bumbble-c061f", storageBucket:"bumbble-c061f.appspot.com", messagingSenderId:"213165886981", appId:"1:213165886981:web:c18652003444869b1bd66c" };
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();

const nav = document.getElementById("navLinks");
const userList = document.getElementById("userList");
const chatModal = document.getElementById("chatModal");
const chatMessages = document.getElementById("chatMessages");
const chatWith = document.getElementById("chatWith");
const chatInput = document.getElementById("chatInput");
const sendBtn = document.getElementById("sendBtn");
const fileBtn = document.getElementById("fileBtn");
const chatFileInput = document.getElementById("chatFileInput");
const typingIndicator = document.getElementById("typingIndicator");
const previewStrip = document.getElementById("previewStrip");

let currentUserUid = "";
let currentChatFriendUid = "";
let currentChatListener = null;
const unreadCounters = {};            // map: senderUid -> count
const lastChatTimestamps = {};
let typingTimeout;

// ===== Auth =====
auth.onAuthStateChanged(user=>{
  if(user && user.emailVerified){
    currentUserUid = user.uid;
    nav.innerHTML = `
      <a href="index.html">Home</a>
      <a href="friends.html">Friends</a>
      <a href="stories.html">Stories</a>
      <a href="events.html">Events</a>
      <a href="safety.html">Safety</a>
      <a href="profile.html">Profile</a>
      <a href="#" id="logoutBtn">Logout</a>`;
    document.getElementById("logoutBtn").addEventListener("click",()=>{
      db.ref('users/'+currentUserUid+'/public/online').set(false);
      localStorage.removeItem("lastChatFriendUid");
      localStorage.removeItem("lastChatFriendName");
      auth.signOut().then(()=>window.location.href="login.html");
    });
    setupOnlineStatus();
    loadUsersRealtime();
    setupUnreadListener();

    const lastUid = localStorage.getItem("lastChatFriendUid");
    const lastName = localStorage.getItem("lastChatFriendName");
    if(lastUid && lastName) openChat(lastUid,lastName);

  } else {
    nav.innerHTML = `<a href="index.html">Home</a><a href="login.html">Login</a><a href="signup.html">Sign Up</a>`;
    document.querySelector(".friends-container").innerHTML="<p>Please login to view users.</p>";
  }
});

function setupOnlineStatus(){
  const userStatusRef = db.ref('users/'+currentUserUid+'/public/online');
  db.ref('.info/connected').on('value',snap=>{
    if(snap.val()===true){
      userStatusRef.set(true);
      userStatusRef.onDisconnect().set(false);
    }
  });
}

// ===== Load Users =====
function loadUsersRealtime(){
  db.ref('users').on('value', snapshot=>{
    const usersData = snapshot.val()||{};
    const friends = Object.keys(usersData).filter(uid=>uid!==currentUserUid).map(uid=>{
      const u = usersData[uid].public||{};
      return { uid, name:u.name||"Unknown", gender:u.gender||"N/A", online:u.online||false };
    });
    friends.sort((a,b)=>{
      const tA = lastChatTimestamps[a.uid]||0;
      const tB = lastChatTimestamps[b.uid]||0;
      return tB-tA || a.name.localeCompare(b.name);
    });
    userList.innerHTML='';
    friends.forEach(f=>{
      const row = document.createElement('div');
      row.className='user-row';
      row.dataset.uid=f.uid;
      row.dataset.name=f.name;
      row.innerHTML=`<div><span class="status-dot ${f.online?'online':'offline'}"></span>${f.name} (${f.gender})</div>`;
      row.addEventListener('click',()=>openChat(f.uid,f.name));
      userList.appendChild(row);
    });
    updateFriendListBadges();
  });
}

// ===== Unread Listener =====
function setupUnreadListener(){
  db.ref('unread/'+currentUserUid).on('value', snap=>{
    // Fully refresh local unreadCounters from snapshot to avoid stale keys
    const data = snap.exists() ? (snap.val() || {}) : {};

    // clear old keys
    Object.keys(unreadCounters).forEach(k=>delete unreadCounters[k]);

    // copy fresh
    Object.keys(data).forEach(senderUid=>{
      unreadCounters[senderUid] = data[senderUid];
    });

    updateFriendListBadges();
  });
}

// ===== Friend Badges & Flash =====
function updateFriendListBadges(){
  document.querySelectorAll('.user-row').forEach(row=>{
    const uid = row.dataset.uid;
    let badge = row.querySelector('.badge');
    const count = Number(unreadCounters[uid] || 0);
    if(count > 0){
      if(!badge){ badge=document.createElement('span'); badge.className='badge'; row.querySelector('div').appendChild(badge); }
      badge.textContent = count;
    } else if(badge) badge.remove();
  });
}

function flashUserRow(uid){
  const row = document.querySelector(`.user-row[data-uid="${uid}"]`);
  if(row){
    row.classList.add('flash');
    setTimeout(()=>row.classList.remove('flash'),800);
  }
}

// ===== Chat Functions =====
function openChat(friendUid,friendName){
  document.querySelectorAll('.user-row').forEach(r=>r.classList.remove('active'));
  const activeRow=document.querySelector(`.user-row[data-uid="${friendUid}"]`);
  if(activeRow) activeRow.classList.add('active');

  currentChatFriendUid = friendUid;
  chatWith.textContent = friendName;
  localStorage.setItem("lastChatFriendUid", friendUid);
  localStorage.setItem("lastChatFriendName", friendName);

  chatModal.style.display='flex';
  chatMessages.innerHTML='';
  typingIndicator.textContent='';

  // Clear unread for this friend (on open)
  db.ref('unread/'+currentUserUid+'/'+friendUid).remove();
  unreadCounters[friendUid]=0;
  updateFriendListBadges();

  const chatId = getChatId(currentUserUid, friendUid);
  if(currentChatListener) currentChatListener.off();

  const chatRef = db.ref('chats/' + chatId);
  chatRef.child('members').update({ [currentUserUid]: true, [friendUid]: true });

  // load history
  chatRef.child('messages').once('value', snap=>{
    const msgs = snap.val()||{};
    Object.keys(msgs).sort((a,b)=> msgs[a].timestamp - msgs[b].timestamp).forEach(k=>addOrUpdateMessageToChat({...msgs[k], _key:k}));
    chatMessages.scrollTop = chatMessages.scrollHeight;
  });

  // realtime listener (do NOT increment unread here)
  currentChatListener = chatRef.child('messages');
  currentChatListener.on('child_added', snap=>{
    const msg = snap.val(); msg._key = snap.key;
    addOrUpdateMessageToChat(msg);
    lastChatTimestamps[friendUid] = msg.timestamp;

    // Defensive: if message is for me and chat is currently open, ensure unread cleared
    if(msg.receiver === currentUserUid && msg.sender !== currentUserUid && currentChatFriendUid === msg.sender){
      db.ref('unread/'+currentUserUid+'/'+msg.sender).remove();
      unreadCounters[msg.sender] = 0;
      updateFriendListBadges();
    }
  });
  currentChatListener.on('child_changed', snap=>{
    const msg = snap.val(); msg._key = snap.key;
    addOrUpdateMessageToChat(msg);
  });

  listenTyping(friendUid);
}

// ===== Render Messages =====
function addOrUpdateMessageToChat(msg){
  if(!msg || !msg._key) return;
  const id='msg-'+msg._key;
  let el=document.getElementById(id);
  const isSelf = msg.sender===currentUserUid;
  if(!el){ el=document.createElement('div'); el.id=id; el.className='message '+(isSelf?'self':'friend'); chatMessages.appendChild(el); }

  if(msg.fileData){
    if(msg.fileType?.startsWith('image/')||msg.fileName?.match(/\.(jpg|jpeg|png|gif)$/i)){
      el.innerHTML=`<img class="chat-image" src="${msg.fileData}" alt="${msg.fileName||'image'}"/><a class="file-link" href="${msg.fileData}" download="${msg.fileName||'image'}">${msg.fileName||'image'}</a><span class="timestamp ${isSelf?'':'friend'}">${new Date(msg.timestamp).toLocaleString()}</span>`;
    } else el.innerHTML=`<div class="small-muted">${msg.fileName||'File'}</div><a class="file-link" href="${msg.fileData}" download="${msg.fileName||'file'}">${msg.fileName||'Download'}</a><span class="timestamp ${isSelf?'':'friend'}">${new Date(msg.timestamp).toLocaleString()}</span>`;
  } else if(msg.uploading){
    el.innerHTML=`<div class="small-muted">${msg.fileName||'Sending...'}</div><span class="uploading-badge">Sending...</span><span class="timestamp ${isSelf?'':'friend'}">${new Date(msg.timestamp).toLocaleString()}</span>`;
  } else if(msg.text) el.innerHTML=`${escapeHtml(msg.text)}<div class="timestamp ${isSelf?'':'friend'}">${new Date(msg.timestamp).toLocaleString()}</div>`;
  else el.innerHTML=`<div class="small-muted">Unknown message</div>`;
  chatMessages.scrollTop=chatMessages.scrollHeight;
}

// ===== Typing =====
chatInput.addEventListener('input',()=>{
  if(!currentChatFriendUid) return;
  db.ref('typing/'+currentChatFriendUid+'/'+currentUserUid).set(true);
  clearTimeout(typingTimeout);
  typingTimeout=setTimeout(()=>db.ref('typing/'+currentChatFriendUid+'/'+currentUserUid).remove(),1000);
});

function listenTyping(friendUid){
  db.ref('typing/'+currentUserUid+'/'+friendUid).on('value',snap=>{
    typingIndicator.textContent = snap.exists()?`${chatWith.textContent} is typing...`:''; 
  });
}

// ===== Send Message =====
function sendMessage(){
  const text=chatInput.value.trim(); if(!text || !currentChatFriendUid) return;
  const chatId=getChatId(currentUserUid,currentChatFriendUid);
  const msgObj={ sender:currentUserUid, receiver:currentChatFriendUid, text, timestamp:Date.now() };
  db.ref('chats/'+chatId+'/members').update({ [currentUserUid]:true, [currentChatFriendUid]:true });
  // push message
  db.ref('chats/'+chatId+'/messages').push(msgObj);

  // IMPORTANT: increment unread for the receiver (so unread is tracked consistently server-side)
  if(currentChatFriendUid !== currentUserUid){
    db.ref('unread/'+currentChatFriendUid+'/'+currentUserUid).transaction(current => (current || 0) + 1);
    // option: flash receiver row if they are online and visible to this client (not required)
  }

  chatInput.value='';
  lastChatTimestamps[currentChatFriendUid]=msgObj.timestamp;
}
chatInput.addEventListener('keydown',e=>{ if(e.key==='Enter'){ e.preventDefault(); sendMessage(); }});
sendBtn.addEventListener('click',sendMessage);

// ===== Close Chat =====
function closeChat(){ chatModal.style.display='none'; if(currentChatListener) currentChatListener.off(); currentChatFriendUid=''; }

// ===== File Upload =====
fileBtn.addEventListener('click',()=>chatFileInput.click());
chatFileInput.addEventListener('change', async e=>{
  if(!currentChatFriendUid) return;
  const files=Array.from(e.target.files);
  const chatId=getChatId(currentUserUid,currentChatFriendUid);
  files.forEach(file=>{
    const reader=new FileReader();
    reader.onload=(ev)=>{
      const msgObj={ sender:currentUserUid, receiver:currentChatFriendUid, fileData:ev.target.result, fileName:file.name, fileType:file.type, timestamp:Date.now() };
      db.ref('chats/'+chatId+'/messages').push(msgObj);
      // increment unread for receiver
      if(currentChatFriendUid !== currentUserUid){
        db.ref('unread/'+currentChatFriendUid+'/'+currentUserUid).transaction(current => (current || 0) + 1);
      }
    };
    reader.readAsDataURL(file);
  });
  chatFileInput.value='';
});

// ===== Helpers =====
function getChatId(uid1,uid2){ return uid1<uid2?uid1+'_'+uid2:uid2+'_'+uid1; }
function escapeHtml(text){ return text.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
</script>
</body>
</html>


