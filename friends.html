<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Bumbble - Friends</title>
<style>
body {
  font-family: Arial, sans-serif;
  background: #fff;
  color: #333;
  margin: 0;
  min-height: 100vh;
}
header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 15px 20px;
  background: #ffcb2b;
}
header h1 { font-size: 24px; margin: 0; }
nav a { margin: 0 10px; text-decoration: none; color: #333; font-weight: bold; }
.container { max-width: 600px; margin: 20px auto; padding: 0 15px; }
h2, h3 { text-align: center; }
input[type=text] { width: 100%; padding: 8px; margin: 10px 0; border-radius: 5px; border: 1px solid #ccc; }
.user-list, .friends-list { margin: 10px 0; border: 1px solid #ddd; border-radius: 5px; padding: 10px; }
.user-item, .friend-item { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
.friend-status { width: 12px; height: 12px; border-radius: 50%; display: inline-block; margin-right: 5px; }
button { padding: 5px 10px; border-radius: 5px; border: none; background: #ffcb2b; cursor: pointer; font-weight: bold; }
button:hover { background: #f1b800; }
button:disabled { background: #ccc; cursor: default; }
</style>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>
<body>

<header>
  <h1>Bumbble</h1>
  <nav id="navLinks"></nav>
</header>

<div class="container">
  <h2>Friends</h2>
  <div>
    <h3>Search Users</h3>
    <input type="text" id="searchUser" placeholder="Search by name">
    <div id="searchResults" class="user-list"></div>
  </div>

  <div>
    <h3>All Users</h3>
    <div id="allUsersList" class="user-list"></div>
  </div>

  <div>
    <h3>Your Friends</h3>
    <div id="friendsList" class="friends-list"></div>
  </div>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyBkDyP8KPuQc_knXLH9lhtQWDLb59xRJWs",
  authDomain: "bumbble-c061f.firebaseapp.com",
  databaseURL: "https://bumbble-c061f-default-rtdb.firebaseio.com",
  projectId: "bumbble-c061f",
  storageBucket: "bumbble-c061f.appspot.com",
  messagingSenderId: "213165886981",
  appId: "1:213165886981:web:c18652003444869b1bd66c"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();

const nav = document.getElementById("navLinks");
let currentUid = null;

// Navigation & auth
auth.onAuthStateChanged(user => {
  if(user && user.emailVerified){
    currentUid = user.uid;
    nav.innerHTML = `
      <a href="index.html">Home</a>
      <a href="friends.html">Friends</a>
      <a href="stories.html">Stories</a>
      <a href="events.html">Events</a>
      <a href="safety.html">Safety</a>
      <a href="profile.html">Profile</a>
      <a href="#" id="logoutBtn">Logout</a>
    `;
    document.getElementById("logoutBtn").addEventListener("click", ()=>auth.signOut().then(()=>window.location.href="login.html"));

    loadFriends();
    loadAllUsers();
    setupSearch();
  } else {
    nav.innerHTML = `<a href="index.html">Home</a><a href="login.html">Login</a><a href="signup.html">Sign Up</a>`;
    document.querySelector(".container").innerHTML = "<p>Please login to view friends.</p>";
  }
});

// Load all friends of current user
function loadFriends(){
  const friendsDiv = document.getElementById("friendsList");
  db.ref(`friends/${currentUid}`).on('value', snapshot => {
    const friendsData = snapshot.val() || {};
    friendsDiv.innerHTML = '';
    for(const fid in friendsData){
      db.ref(`users/${fid}/public`).once('value').then(snap => {
        const data = snap.val() || {};
        const div = document.createElement('div');
        div.className = 'friend-item';
        div.innerHTML = `<span><span class="friend-status" style="background:${data.online?'green':'red'}"></span>${data.name||"Unnamed"}</span>`;
        friendsDiv.appendChild(div);
      });
    }
  });
}

// Load all users
function loadAllUsers(){
  const container = document.getElementById('allUsersList');
  db.ref('users').on('value', snapshot => {
    const allUsers = snapshot.val() || {};
    container.innerHTML = '';
    for(const uid in allUsers){
      if(uid === currentUid) continue;

      const publicData = allUsers[uid].public || {};
      const onlineStatus = publicData.online?'green':'red';
      const isFriend = allUsers[currentUid]?.friends?.[uid] !== undefined;

      const userDiv = document.createElement('div');
      userDiv.className = 'user-item';
      userDiv.innerHTML = `
        <span><span class="friend-status" style="background:${onlineStatus}"></span>${publicData.name || "Unnamed"}</span>
        <button ${isFriend?'disabled':''} onclick="addFriend('${uid}')">${isFriend?'Added':'Add'}</button>
      `;
      container.appendChild(userDiv);
    }
  });
}

// Add friend
function addFriend(friendUid){
  if(!currentUid) return;
  db.ref(`friends/${currentUid}/${friendUid}`).set(true).then(()=> {
    alert("Friend added!");
  });
}

// Search users by name
function setupSearch(){
  const searchInput = document.getElementById("searchUser");
  const resultsDiv = document.getElementById("searchResults");

  searchInput.addEventListener('input', async e => {
    const searchText = e.target.value.toLowerCase();
    const allUsersSnap = await db.ref('users').once('value');
    const allUsers = allUsersSnap.val() || {};
    resultsDiv.innerHTML = '';

    for(const uid in allUsers){
      if(uid === currentUid) continue;
      const data = allUsers[uid].public || {};
      if(data.name && data.name.toLowerCase().includes(searchText)){
        const onlineStatus = data.online?'green':'red';
        const isFriend = allUsers[currentUid]?.friends?.[uid] !== undefined;
        const div = document.createElement('div');
        div.className = 'user-item';
        div.innerHTML = `
          <span><span class="friend-status" style="background:${onlineStatus}"></span>${data.name}</span>
          <button ${isFriend?'disabled':''} onclick="addFriend('${uid}')">${isFriend?'Added':'Add'}</button>
        `;
        resultsDiv.appendChild(div);
      }
    }
  });
}
</script>
</body>
</html>
