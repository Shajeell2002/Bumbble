// ===== Unread Message Counters =====
const unreadCounters = {};
const lastChatTimestamps = {};

function updateFriendListBadges() {
  document.querySelectorAll('.user-row').forEach(row => {
    const uid = row.dataset.uid;
    const badge = row.querySelector('.badge');
    if (unreadCounters[uid]) {
      if (badge) badge.textContent = unreadCounters[uid];
      else {
        const span = document.createElement('span');
        span.className = 'badge';
        span.textContent = unreadCounters[uid];
        row.querySelector('div').appendChild(span);
      }
    } else if (badge) badge.remove();
  });
}

// Listen for unread messages
db.ref('chats').on('child_added', snap => {
  snap.ref.child('messages').on('child_added', msgSnap => {
    const msg = msgSnap.val();
    if (msg?.receiver === currentUserUid && msg.sender !== currentChatFriendUid) {
      unreadCounters[msg.sender] = (unreadCounters[msg.sender] || 0) + 1;
      lastChatTimestamps[msg.sender] = msg.timestamp;
      updateFriendListBadges();
    }
  });
});

// ===== Drag Chat Modal =====
function dragElement(el) {
  let pos1=0,pos2=0,pos3=0,pos4=0;
  const header = document.getElementById("chatHeader");
  if(header) header.onmousedown=dragMouseDown; else el.onmousedown=dragMouseDown;

  function dragMouseDown(e){
    e.preventDefault();
    pos3 = e.clientX; pos4 = e.clientY;
    document.onmouseup = closeDragElement;
    document.onmousemove = elementDrag;
  }

  function elementDrag(e){
    e.preventDefault();
    pos1 = pos3 - e.clientX; pos2 = pos4 - e.clientY;
    pos3 = e.clientX; pos4 = e.clientY;
    const newTop = Math.max(0, Math.min(window.innerHeight - el.offsetHeight, el.offsetTop - pos2));
    const newLeft = Math.max(0, Math.min(window.innerWidth - el.offsetWidth, el.offsetLeft - pos1));
    el.style.top = newTop + 'px';
    el.style.left = newLeft + 'px';
  }

  function closeDragElement(){ document.onmouseup=null; document.onmousemove=null; }
}
dragElement(chatModal);

// ===== File Upload & Preview Strip =====
chatFileInput.addEventListener('change', handleFiles);
fileBtn.addEventListener('click',()=>chatFileInput.click());

const localPreviewMap = {};

function handleFiles(){
  const files = Array.from(chatFileInput.files||[]);
  if(!files.length || !currentChatFriendUid){ chatFileInput.value=''; return; }

  previewStrip.innerHTML=''; previewStrip.style.display='flex';
  const chatId = getChatId(currentUserUid,currentChatFriendUid);
  db.ref('chats/'+chatId+'/members').update({ [currentUserUid]:true, [currentChatFriendUid]:true });

  files.forEach(file => {
    const msgRef = db.ref('chats/'+chatId+'/messages').push();
    const key = msgRef.key;
    const placeholder = { sender:currentUserUid, receiver:currentChatFriendUid, timestamp:Date.now(), fileName:file.name, fileType:file.type||'', uploading:true };
    msgRef.set(placeholder).then(()=>{
      if(file.type.startsWith('image/')){
        const objUrl = URL.createObjectURL(file);
        localPreviewMap[key] = objUrl;
        addPreviewThumb(key,objUrl,file.name);
        compressImageToDataURL(file,64*1024,dataUrl => {
          db.ref('chats/'+chatId+'/messages/'+key).update({ fileData:dataUrl, uploading:false });
        });
      } else {
        addPreviewThumb(key,null,file.name);
        const reader = new FileReader();
        reader.onload = e => db.ref('chats/'+chatId+'/messages/'+key).update({ fileData:e.target.result, uploading:false });
        reader.readAsDataURL(file);
      }
    });
  });
  chatFileInput.value='';
}

function addPreviewThumb(key,url,name){
  const container = document.createElement('div');
  container.dataset.temp = key;
  container.style.display='flex'; container.style.flexDirection='column'; container.style.alignItems='center'; container.style.width='70px';
  if(url){ const img=document.createElement('img'); img.src=url; img.className='preview-thumb'; container.appendChild(img); }
  else { const box=document.createElement('div'); box.className='preview-thumb'; box.style.display='flex'; box.style.alignItems='center'; box.style.justifyContent='center'; box.textContent=name.split('.')[0]; box.style.fontSize='11px'; container.appendChild(box); }
  const progressBar=document.createElement('div'); progressBar.className='progress-bar';
  progressBar.innerHTML='<div class="progress-fill" style="width:30%"></div>';
  container.appendChild(progressBar);
  previewStrip.appendChild(container);
}

// ===== Image Compression =====
function compressImageToDataURL(file,maxBytes,callback){
  if(file.size<=maxBytes){ const r=new FileReader(); r.onload=e=>callback(e.target.result); r.readAsDataURL(file); return; }
  const reader = new FileReader();
  reader.onload = e=>{
    const img = new Image();
    img.onload = ()=>{
      let scale=Math.sqrt(maxBytes/file.size); scale=Math.min(1,Math.max(0.1,scale)); let quality=0.9;
      const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d');
      (function attempt(){
        canvas.width=Math.max(1,Math.round(img.width*scale));
        canvas.height=Math.max(1,Math.round(img.height*scale));
        ctx.clearRect(0,0,canvas.width,canvas.height);
        ctx.drawImage(img,0,0,canvas.width,canvas.height);
        try{
          const dataUrl=canvas.toDataURL(file.type||'image/jpeg',quality);
          const approxBytes=Math.round((dataUrl.split(',')[1]||'').length*3/4);
          if(approxBytes<=maxBytes||(quality<=0.35&&scale<=0.25)) callback(dataUrl);
          else { if(quality>0.4) quality=Math.max(0.35,quality-0.15); else scale=Math.max(0.2,scale*0.8); setTimeout(attempt,10); }
        } catch(e){ const r2 = new FileReader(); r2.onload=ev=>callback(ev.target.result); r2.readAsDataURL(file); }
      })();
    };
    img.src=e.target.result;
  };
  reader.readAsDataURL(file);
}

// Revoke object URLs on unload
window.addEventListener('beforeunload', ()=>{
  Object.values(localPreviewMap).forEach(url => { try{ if(url.startsWith('blob:')) URL.revokeObjectURL(url); }catch(e){} });
});
