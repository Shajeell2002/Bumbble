<script>
document.getElementById("signupForm").addEventListener("submit", function(e){
  e.preventDefault();

  const name = document.getElementById("name").value.trim();
  const email = document.getElementById("email").value.trim();
  const password = document.getElementById("password").value.trim();
  const gender = document.getElementById("gender").value;   // no trim()
  const location = document.getElementById("location").value.trim();

  if (!name || !email || !password || !gender || !location) {
    alert("⚠️ Please fill all fields.");
    return;
  }

  auth.createUserWithEmailAndPassword(email, password)
    .then((userCredential) => {
      const user = userCredential.user;

      // ✅ Save user in Realtime Database FIRST
      return db.ref("users/" + user.uid).set({
        name: name,
        email: email,
        gender: gender,
        location: location,
        lastLogin: Date.now(),
        verified: user.emailVerified,
        pic: "images/profile1.png"
      }).then(() => {
        console.log("✅ User saved in DB with gender & location");

        // ✅ THEN send verification email
        return user.sendEmailVerification();
      });
    })
    .then(() => {
      alert("✅ Verification email sent! Please check your inbox or spam.");
      document.getElementById("signupForm").reset();
    })
    .catch((error) => {
      alert("❌ " + error.message);
      console.error(error);
    });
});

// Prevent unverified users from logging in
auth.onAuthStateChanged((user) => {
  if (user) {
    if (!user.emailVerified) {
      alert("⚠️ Please verify your email before logging in.");
      auth.signOut();
    }
  }
});
</script>
