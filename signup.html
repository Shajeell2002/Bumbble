<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Bumbble - Sign Up</title>
<style>
body{font-family:Arial,sans-serif;background:#fff;color:#333;display:flex;flex-direction:column;align-items:center;min-height:100vh;margin:0;padding:0;}
h1{margin-top:40px;color:#ffcb2b;}
form{display:flex;flex-direction:column;width:300px;margin-top:20px;}
input,button{margin:8px 0;padding:10px;border-radius:6px;border:1px solid #ccc;font-size:14px;}
button{background:#ffcb2b;color:#333;font-weight:bold;border:none;cursor:pointer;}
#otpContainer, #emailContainer{display:none;}
#message{color:red;font-size:14px;margin-top:5px;}
</style>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>
<body>

<h1>Bumbble - Sign Up</h1>

<!-- Step 1: Mobile -->
<div id="mobileContainer">
  <input type="text" id="name" placeholder="Full Name" required>
  <input type="number" id="age" placeholder="Age" required>
  <input type="text" id="phone" placeholder="Mobile Number (+CountryCode)" required>
  <button id="sendOtpBtn">Send OTP</button>
</div>

<!-- Step 2: Enter OTP -->
<div id="otpContainer">
  <h3>Enter OTP sent to your mobile</h3>
  <input type="text" id="otpInput" placeholder="OTP">
  <button id="verifyOtpBtn">Verify OTP</button>
</div>

<!-- Step 3: Email signup -->
<div id="emailContainer">
  <input type="email" id="email" placeholder="Email" required>
  <input type="password" id="password" placeholder="Password" required>
  <button id="signupBtn">Sign Up</button>
</div>

<div id="message"></div>
<div id="recaptcha-container"></div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyBkDyP8KPuQc_knXLH9lhtQWDLb59xRJWs",
  authDomain: "bumbble-c061f.firebaseapp.com",
  databaseURL: "https://bumbble-c061f-default-rtdb.firebaseio.com",
  projectId: "bumbble-c061f",
  storageBucket: "bumbble-c061f.appspot.com",
  messagingSenderId: "213165886981",
  appId: "1:213165886981:web:c18652003444869b1bd66c"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();

const recaptchaVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', {
  'size': 'invisible'
});

let confirmationResultGlobal=null;
let mobileVerified=false;
let userMobile, userName, userAge;

const messageDiv=document.getElementById("message");

document.getElementById("sendOtpBtn").addEventListener("click", ()=>{
  userName=document.getElementById("name").value.trim();
  userAge=document.getElementById("age").value.trim();
  userMobile=document.getElementById("phone").value.trim();

  if(!userName || !userAge || !userMobile){
    messageDiv.textContent="Please fill all fields.";
    return;
  }
  messageDiv.textContent="";

  auth.signInWithPhoneNumber(userMobile, recaptchaVerifier)
  .then(confirmationResult=>{
    confirmationResultGlobal=confirmationResult;
    document.getElementById("mobileContainer").style.display="none";
    document.getElementById("otpContainer").style.display="block";
    messageDiv.textContent="OTP sent to mobile.";
  })
  .catch(err=>{
    console.error(err);
    messageDiv.textContent="Error sending OTP: "+err.message;
  });
});

// Verify OTP
document.getElementById("verifyOtpBtn").addEventListener("click", ()=>{
  const code=document.getElementById("otpInput").value.trim();
  if(!code){ messageDiv.textContent="Enter OTP"; return; }
  confirmationResultGlobal.confirm(code)
  .then(result=>{
    mobileVerified=true;
    document.getElementById("otpContainer").style.display="none";
    document.getElementById("emailContainer").style.display="block";
    messageDiv.textContent="Mobile verified. Now enter email & password.";
  })
  .catch(err=>{
    console.error(err);
    messageDiv.textContent="Invalid OTP: "+err.message;
  });
});

// Email signup
document.getElementById("signupBtn").addEventListener("click", ()=>{
  if(!mobileVerified){ messageDiv.textContent="Please verify mobile first"; return; }

  const email=document.getElementById("email").value.trim();
  const password=document.getElementById("password").value.trim();
  if(!email || !password){ messageDiv.textContent="Enter email & password"; return; }
  messageDiv.textContent="";

  auth.createUserWithEmailAndPassword(email,password)
  .then(userCredential=>{
    const user=userCredential.user;

    // Send email verification
    user.sendEmailVerification().then(()=>{
      alert("Email verification sent. Check your inbox.");

      // Save public info
      db.ref("users/"+user.uid+"/userPublic").set({
        name:userName,
        age:userAge,
        pic:"default.png",
        online:false
      });

      // Save private info
      db.ref("users/"+user.uid+"/private").set({
        email:email,
        phone:userMobile
      });

      window.location.href="login.html";

    }).catch(err=>{
      console.error(err);
      messageDiv.textContent="Email verification failed: "+err.message;
    });
  })
  .catch(err=>{
    console.error(err);
    messageDiv.textContent="Signup failed: "+err.message;
  });
});
</script>
</body>
</html>
